"use strict";exports.id=8651,exports.ids=[8651],exports.modules={68651:(a,b,c)=>{c.d(b,{N:()=>f});var d=c(75535),e=c(56525);class f{static{this.watchId=null}static{this.isTracking=!1}static async getCurrentPosition(){return new Promise((a,b)=>{if(!navigator.geolocation)return void b(Error("Geolocation is not supported by this browser"));navigator.geolocation.getCurrentPosition(b=>{a({latitude:b.coords.latitude,longitude:b.coords.longitude,accuracy:b.coords.accuracy,timestamp:d.Dc.now()})},a=>{b(Error(`Geolocation error: ${a.message}`))},{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4})})}static async getAddressFromCoordinates(a,b){let d=process.env.NEXT_PUBLIC_OPENCAGE_API_KEY;if(!d||"YOUR_OPENCAGE_API_KEY"===d){let{ChileanCitiesService:d}=await c.e(8093).then(c.bind(c,58093)),e=d.getNearbyCities(a,b,10);if(e.length>0){let a=e[0];return{street:"Direcci\xf3n no disponible",city:a.name,state:a.region,zipCode:"",country:"Chile",fullAddress:`${a.name}, ${a.region}, Chile`}}return{street:"Direcci\xf3n no disponible",city:"Santiago",state:"Regi\xf3n Metropolitana",zipCode:"",country:"Chile",fullAddress:"Santiago, Regi\xf3n Metropolitana, Chile"}}try{let e=await fetch(`https://api.opencagedata.com/geocode/v1/json?q=${a}+${b}&key=${d}&language=es&countrycode=cl`);if(!e.ok)throw console.warn("Geocoding service temporarily unavailable, using fallback address"),Error("Geocoding service unavailable");let f=await e.json();if(f.results&&f.results.length>0){let a=f.results[0],b=a.components;return{street:`${b.house_number||""} ${b.road||""}`.trim(),city:b.city||b.town||b.village||"Santiago",state:b.state||"Regi\xf3n Metropolitana",zipCode:b.postcode||"",country:b.country||"Chile",fullAddress:a.formatted}}{let{ChileanCitiesService:d}=await c.e(8093).then(c.bind(c,58093)),e=d.getNearbyCities(a,b,10);if(e.length>0){let a=e[0];return{street:"Direcci\xf3n no disponible",city:a.name,state:a.region,zipCode:"",country:"Chile",fullAddress:`${a.name}, ${a.region}, Chile`}}return{street:"Direcci\xf3n no disponible",city:"Santiago",state:"Regi\xf3n Metropolitana",zipCode:"",country:"Chile",fullAddress:"Santiago, Regi\xf3n Metropolitana, Chile"}}}catch(f){let{ChileanCitiesService:d}=await c.e(8093).then(c.bind(c,58093)),e=d.getNearbyCities(a,b,10);if(e.length>0){let a=e[0];return{street:"Direcci\xf3n no disponible",city:a.name,state:a.region,zipCode:"",country:"Chile",fullAddress:`${a.name}, ${a.region}, Chile`}}return f instanceof Error&&!f.message.includes("Geocoding service unavailable")&&console.error("Unexpected error getting address:",f),{street:"Direcci\xf3n no disponible",city:"Santiago",state:"Regi\xf3n Metropolitana",zipCode:"",country:"Chile",fullAddress:"Santiago, Regi\xf3n Metropolitana, Chile"}}}static calculateDistance(a,b,c,d){let e=this.toRadians(c-a),f=this.toRadians(d-b),g=Math.sin(e/2)*Math.sin(e/2)+Math.cos(this.toRadians(a))*Math.cos(this.toRadians(c))*Math.sin(f/2)*Math.sin(f/2);return Math.round(2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g))*63710)/10}static toRadians(a){return Math.PI/180*a}static async updateCookLocation(a){try{let b=await this.getCurrentPosition(),c=await this.getAddressFromCoordinates(b.latitude,b.longitude),f={coordinates:b,address:c,isActive:!0,lastUpdated:d.Dc.now()};return await (0,d.mZ)((0,d.doc)(e.db,"cooks",a),{location:f,"settings.lastLocationUpdate":d.Dc.now()}),!0}catch(a){return console.error("Error updating cook location:",a),!1}}static startDriverTracking(a,b){return this.isTracking?(console.warn("Location tracking is already active"),!1):navigator.geolocation?(this.isTracking=!0,this.watchId=navigator.geolocation.watchPosition(async c=>{try{let f={latitude:c.coords.latitude,longitude:c.coords.longitude,accuracy:c.coords.accuracy,timestamp:d.Dc.now()},g=await this.getAddressFromCoordinates(f.latitude,f.longitude),h={driverId:a,coordinates:f,address:g,isActive:!0,isOnline:!0,lastUpdated:d.Dc.now()};null!==c.coords.heading&&void 0!==c.coords.heading&&(h.heading=c.coords.heading),null!==c.coords.speed&&void 0!==c.coords.speed&&(h.speed=3.6*c.coords.speed),await (0,d.mZ)((0,d.doc)(e.db,"drivers",a),{currentLocation:h,lastLocationUpdate:d.Dc.now(),isOnline:!0}),b&&b(h)}catch(a){console.error("Error updating driver location:",a)}},b=>{console.error("Geolocation error:",b),this.stopDriverTracking(a)},{enableHighAccuracy:!0,timeout:15e3,maximumAge:5e3}),!0):(console.error("Geolocation is not supported"),!1)}static async stopDriverTracking(a){null!==this.watchId&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.isTracking=!1;try{await (0,d.mZ)((0,d.doc)(e.db,"drivers",a),{isOnline:!1,lastLocationUpdate:d.Dc.now()})}catch(a){console.error("Error updating driver offline status:",a)}}static subscribeToDriverLocation(a,b){return(0,d.aQ)((0,d.doc)(e.db,"drivers",a),a=>{a.exists()?b(a.data().currentLocation):b(null)})}static async getNearbyCooks(a,b,d=10){try{return(await Promise.resolve().then(c.bind(c,87675)).then(a=>a.CooksService.getAllCooks())).filter(c=>!!c.location?.coordinates&&this.calculateDistance(a,b,c.location.coordinates.latitude,c.location.coordinates.longitude)<=d).map(c=>({...c,distance:this.calculateDistance(a,b,c.location.coordinates.latitude,c.location.coordinates.longitude)})).sort((a,b)=>a.distance-b.distance)}catch(a){return console.error("Error getting nearby cooks:",a),[]}}static estimateDeliveryTime(a){return Math.ceil(15+a/25*60)}static async checkLocationPermission(){if(!navigator.permissions)return!1;try{let a=await navigator.permissions.query({name:"geolocation"});return"granted"===a.state}catch(a){return console.error("Error checking location permission:",a),!1}}static async requestLocationPermission(){try{return await this.getCurrentPosition(),!0}catch(a){return console.error("Location permission denied:",a),!1}}static getDefaultDeliveryZones(){return[{id:"zone-centro",name:"Centro de Santiago",coordinates:[],center:{latitude:-33.4489,longitude:-70.6693,timestamp:d.Dc.now()},radius:5e3,deliveryFee:2e3,isActive:!0,maxDeliveryTime:45,priority:1,description:"Centro hist\xf3rico y comercial de Santiago",operatingHours:{start:"08:00",end:"22:00"}},{id:"zone-providencia",name:"Providencia",coordinates:[],center:{latitude:-33.4242,longitude:-70.6118,timestamp:d.Dc.now()},radius:3e3,deliveryFee:2500,isActive:!0,maxDeliveryTime:35,priority:2,description:"Zona residencial y comercial",operatingHours:{start:"09:00",end:"23:00"}},{id:"zone-las-condes",name:"Las Condes",coordinates:[],center:{latitude:-33.4172,longitude:-70.5476,timestamp:d.Dc.now()},radius:4e3,deliveryFee:3e3,isActive:!0,maxDeliveryTime:50,priority:3,description:"Distrito financiero y residencial",operatingHours:{start:"10:00",end:"22:00"}},{id:"zone-nunoa",name:"\xd1u\xf1oa",coordinates:[],center:{latitude:-33.4569,longitude:-70.5956,timestamp:d.Dc.now()},radius:3500,deliveryFee:2300,isActive:!0,maxDeliveryTime:40,priority:4,description:"Comuna universitaria y residencial",operatingHours:{start:"08:30",end:"22:30"}}]}static isWithinDeliveryZone(a,b){return 1e3*this.calculateDistance(a.latitude,a.longitude,b.center.latitude,b.center.longitude)<=b.radius}static findDeliveryZone(a,b){let c=b.filter(b=>b.isActive&&this.isWithinDeliveryZone(a,b)).sort((a,b)=>a.priority-b.priority);return c.length>0?c[0]:null}static isPointInPolygon(a,b){let c=!1;for(let d=0,e=b.length-1;d<b.length;e=d++)b[d].latitude>a.latitude!=b[e].latitude>a.latitude&&a.longitude<(b[e].longitude-b[d].longitude)*(a.latitude-b[d].latitude)/(b[e].latitude-b[d].latitude)+b[d].longitude&&(c=!c);return c}static calculateDeliveryTime(a){return 15+Math.ceil(5*a)}static calculateDeliveryFee(a,b,c=this.getDefaultDeliveryZones()){let d=this.calculateDistance(a.latitude,a.longitude,b.latitude,b.longitude),e=this.findDeliveryZone(a,c),f=0;d>3&&(f=800*Math.ceil(d-3));let g=e?e.deliveryFee:2500,h=1500+f+g,i=this.estimateAdvancedDeliveryTime(d,e);return{baseFee:1500,distanceFee:f,zoneFee:g,totalFee:h,distance:Math.round(10*d)/10,estimatedTime:i}}static estimateAdvancedDeliveryTime(a,b){let c=20;b&&(c=Math.min(c,b.maxDeliveryTime-15));let d=new Date().getHours(),e=1;return d>=7&&d<=9||d>=18&&d<=20?e=1.5:d>=12&&d<=14&&(e=1.2),Math.max(15,Math.ceil(c+a/22*60*e))}static isDeliveryAllowed(a,b=this.getDefaultDeliveryZones()){return b.some(b=>b.isActive&&this.isWithinDeliveryZone(a,b))}static getDeliveryRestrictions(a,b=this.getDefaultDeliveryZones()){let c=this.findDeliveryZone(a,b);return c?{allowed:!0,zone:c}:{allowed:!1,reason:"Esta direcci\xf3n est\xe1 fuera de nuestras zonas de entrega",nearestZone:b.filter(a=>a.isActive).map(b=>({zone:b,distance:this.calculateDistance(a.latitude,a.longitude,b.center.latitude,b.center.longitude)})).sort((a,b)=>a.distance-b.distance)[0]}}static async getDishesForLocation(a,b=10){try{if(!this.getDeliveryRestrictions(a).allowed)return[];let d=await this.getNearbyCooks(a.latitude,a.longitude,b),{DishesService:e}=await Promise.resolve().then(c.bind(c,87675));return(await e.getAllDishes()).filter(a=>d.find(b=>b.id===a.cookerId)&&a.isAvailable).map(b=>{let c=d.find(a=>a.id===b.cookerId),e=this.calculateDeliveryFee(a,c.location.coordinates);return{...b,cookDistance:c.distance,deliveryFee:e.totalFee,estimatedDeliveryTime:e.estimatedTime,cookLocation:c.location}}).sort((a,b)=>a.cookDistance-b.cookDistance)}catch(a){return console.error("Error getting dishes for location:",a),[]}}static async getDishesForChileanCity(a){try{let{ChileanCitiesService:b}=await c.e(8093).then(c.bind(c,58093)),d=b.getCityById(a);if(!d)return console.warn(`City ${a} not found`),[];if(!b.isCityOperating(a))return[];let e=await this.getNearbyCooks(d.coordinates.latitude,d.coordinates.longitude,d.maxDeliveryRadius),{DishesService:f}=await Promise.resolve().then(c.bind(c,87675));return(await f.getAllDishes()).filter(a=>e.find(b=>b.id===a.cookerId)&&a.isAvailable).map(c=>{let f=e.find(a=>a.id===c.cookerId),g=b.getDeliveryFeeForCity(a);return{...c,cityId:a,cityName:d.name,region:d.region,cookDistance:f.distance,deliveryFee:g,estimatedDeliveryTime:this.calculateDeliveryTime(f.distance),cookLocation:f.location,localSpecialties:b.getLocalSpecialtiesForCity(a),popularDishes:b.getPopularDishesForCity(a)}}).sort((a,b)=>a.cookDistance-b.cookDistance)}catch(a){return console.error("Error getting dishes for Chilean city:",a),[]}}static async getDishesForCurrentLocation(){try{let a=await this.getCurrentPosition();await this.getAddressFromCoordinates(a.latitude,a.longitude);let{ChileanCitiesService:b}=await c.e(8093).then(c.bind(c,58093)),d=b.getNearbyCities(a.latitude,a.longitude,50);if(!(d.length>0))return await this.getDishesForLocation(a,15);{let a=d[0];return await this.getDishesForChileanCity(a.id)}}catch(a){return console.error("Error getting dishes for current location:",a),[]}}static async getAvailableChileanCities(){try{let{ChileanCitiesService:a}=await c.e(8093).then(c.bind(c,58093));return a.getActiveCities().map(b=>({id:b.id,name:b.name,region:b.region,coordinates:b.coordinates,deliveryFee:b.deliveryFee,isOperating:a.isCityOperating(b.id),operatingHours:a.getOperatingHoursForCity(b.id),popularDishes:b.popularDishes,localSpecialties:b.localSpecialties}))}catch(a){return console.error("Error getting available Chilean cities:",a),[]}}static formatDeliveryFee(a){return`$${a.toLocaleString("es-CL")} CLP`}static formatDistance(a){return a<1?`${Math.round(1e3*a)} m`:`${a.toFixed(1)} km`}static getDeliveryZoneById(a,b=this.getDefaultDeliveryZones()){return b.find(b=>b.id===a)||null}static isZoneOperating(a){if(!a.operatingHours)return!0;let b=new Date,c=`${b.getHours().toString().padStart(2,"0")}:${b.getMinutes().toString().padStart(2,"0")}`;return c>=a.operatingHours.start&&c<=a.operatingHours.end}static getActiveZones(a=this.getDefaultDeliveryZones()){return a.filter(a=>a.isActive&&this.isZoneOperating(a))}}}};