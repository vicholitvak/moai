"use strict";exports.id=614,exports.ids=[614],exports.modules={614:(a,b,c)=>{c.d(b,{ChatService:()=>f});var d=c(34717),e=c(79767);class f{static{this.MESSAGES_COLLECTION="chatMessages"}static{this.ROOMS_COLLECTION="chatRooms"}static async createChatRoom(a,b,c,f){try{if(!a||0===a.length)return console.error("Cannot create chat room: no participants provided"),null;console.log("Creating chat room with participants:",a);let g={participants:a,participantDetails:b,type:c,orderId:f,createdAt:(0,d.O5)(),updatedAt:(0,d.O5)(),status:"active",unreadCount:a.reduce((a,b)=>(a[b]=0,a),{})},h=await (0,d.gS)((0,d.rJ)(e.db,this.ROOMS_COLLECTION),g);return console.log("Chat room created with ID:",h.id),h.id}catch(a){return console.error("Error creating chat room:",a),a instanceof Error&&console.error("Error details:",a.message),null}}static async getOrCreateOrderChatRoom(a,b,c,f){try{console.log("Getting or creating chat room for order:",a,"participants:",{cookerId:b,customerId:c,driverId:f});let g=(0,d.P)((0,d.rJ)(e.db,this.ROOMS_COLLECTION),(0,d._M)("type","==","order"),(0,d._M)("orderId","==",a)),h=await (0,d.GG)(g);if(!h.empty)return console.log("Chat room already exists for order:",a),h.docs[0].id;if(!b||!c)return console.error("Cannot create chat room: missing required participants (cookerId or customerId)"),null;let i=[b,c];f&&i.push(f);let j={};for(let a of i)try{let b=await (0,d.getDoc)((0,d.doc)(e.db,"users",a));if(b.exists()){let c=b.data();j[a]={name:c.displayName||c.email||"Usuario",role:c.role?.toLowerCase()||"customer",avatar:c.photoURL||c.avatar}}else console.warn(`User document not found for ${a}, using default details`),j[a]={name:"Usuario",role:"customer"}}catch(b){console.warn(`Could not load details for user ${a}:`,b),j[a]={name:"Usuario",role:"customer"}}return await this.createChatRoom(i,j,"order",a)}catch(a){return console.error("Error getting or creating order chat room:",a),null}}static async sendMessage(a,b,c,f="text",g){try{let h=await (0,d.getDoc)((0,d.doc)(e.db,"users",b)),i=h.exists()?h.data():{},j={senderId:b,senderName:i.displayName||i.email||"Usuario",senderRole:i.role?.toLowerCase()||"customer",senderAvatar:i.photoURL||i.avatar,message:c,timestamp:(0,d.O5)(),type:f,metadata:g,readBy:[b]};await (0,d.gS)((0,d.rJ)(e.db,this.ROOMS_COLLECTION,a,this.MESSAGES_COLLECTION),j),await (0,d.mZ)((0,d.doc)(e.db,this.ROOMS_COLLECTION,a),{lastMessage:{message:c,senderId:b,timestamp:(0,d.O5)(),type:f},updatedAt:(0,d.O5)(),[`unreadCount.${b}`]:0});let k=await (0,d.getDoc)((0,d.doc)(e.db,this.ROOMS_COLLECTION,a));if(k.exists()){let c=k.data(),f={};c.participants.forEach(a=>{a!==b&&(f[`unreadCount.${a}`]=(c.unreadCount[a]||0)+1)}),Object.keys(f).length>0&&await (0,d.mZ)((0,d.doc)(e.db,this.ROOMS_COLLECTION,a),f)}return console.log("Message sent successfully"),!0}catch(a){return console.error("Error sending message:",a),!1}}static async sendSystemMessage(a,b,c){try{let f={senderId:"system",senderName:"Sistema",senderRole:"admin",message:b,timestamp:(0,d.O5)(),type:"system",metadata:c,readBy:[]};return await (0,d.gS)((0,d.rJ)(e.db,this.ROOMS_COLLECTION,a,this.MESSAGES_COLLECTION),f),await (0,d.mZ)((0,d.doc)(e.db,this.ROOMS_COLLECTION,a),{lastMessage:{message:b,senderId:"system",timestamp:(0,d.O5)(),type:"system"},updatedAt:(0,d.O5)()}),!0}catch(a){return console.error("Error sending system message:",a),!1}}static async markMessagesAsRead(a,b){try{return await (0,d.mZ)((0,d.doc)(e.db,this.ROOMS_COLLECTION,a),{[`unreadCount.${b}`]:0,[`participantDetails.${b}.lastSeen`]:(0,d.O5)()}),!0}catch(a){return console.error("Error marking messages as read:",a),!1}}static subscribeToMessages(a,b){let c=(0,d.P)((0,d.rJ)(e.db,this.ROOMS_COLLECTION,a,this.MESSAGES_COLLECTION),(0,d.My)("timestamp","asc"),(0,d.AB)(100));return(0,d.aQ)(c,a=>{b(a.docs.map(a=>({id:a.id,...a.data()})))})}static subscribeToUserChatRooms(a,b){let c=(0,d.P)((0,d.rJ)(e.db,this.ROOMS_COLLECTION),(0,d._M)("participants","array-contains",a),(0,d._M)("status","==","active"),(0,d.My)("updatedAt","desc"));return(0,d.aQ)(c,a=>{b(a.docs.map(a=>({id:a.id,...a.data()})))})}static async getTotalUnreadCount(a){try{let b=(0,d.P)((0,d.rJ)(e.db,this.ROOMS_COLLECTION),(0,d._M)("participants","array-contains",a),(0,d._M)("status","==","active")),c=await (0,d.GG)(b),f=0;return c.docs.forEach(b=>{let c=b.data();f+=c.unreadCount[a]||0}),f}catch(a){return console.error("Error getting total unread count:",a),0}}static async archiveChatRoom(a){try{return await (0,d.mZ)((0,d.doc)(e.db,this.ROOMS_COLLECTION,a),{status:"archived",updatedAt:(0,d.O5)()}),!0}catch(a){return console.error("Error archiving chat room:",a),!1}}static async sendLocationMessage(a,b,c){return await this.sendMessage(a,b,`üìç Ubicaci\xf3n compartida: ${c.address}`,"location",{location:c})}static async sendOrderUpdateMessage(a,b,c,d){let e={accepted:"‚úÖ Pedido aceptado y en preparaci\xf3n",preparing:"\uD83D\uDC68‚Äç\uD83C\uDF73 Preparando tu pedido...",ready:"\uD83D\uDCE6 \xa1Pedido listo para recoger!",delivering:"\uD83D\uDE9A Pedido en camino",delivered:"\uD83C\uDF89 \xa1Pedido entregado!"}[c]||`Estado actualizado: ${c}`;return await this.sendSystemMessage(a,e,{orderId:b})}}}};