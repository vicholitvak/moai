"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[977,7764],{13008:(e,t,r)=>{r.d(t,{_:()=>a});class a{static initialize(){return this.publicKey?(this.initialized||(this.initialized=!0),!0):(console.error("Mercado Pago public key not found in environment variables"),!1)}static async createPreference(e){try{let t=await fetch("/api/mercadopago/create-preference",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw Error("Failed to create payment preference");return await t.json()}catch(e){throw console.error("Error creating payment preference:",e),e}}static async processPayment(e){try{let t=await fetch("/api/mercadopago/process-payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw Error("Payment processing failed");return await t.json()}catch(e){throw console.error("Error processing payment:",e),e}}static async getPaymentStatus(e){try{let t=await fetch("/api/mercadopago/payment-status/".concat(e));if(!t.ok)throw Error("Failed to get payment status");return await t.json()}catch(e){throw console.error("Error getting payment status:",e),e}}static getPaymentStatusText(e){switch(e){case"approved":return"Pago aprobado";case"pending":return"Pago pendiente";case"in_process":return"Pago en proceso";case"rejected":return"Pago rechazado";case"cancelled":return"Pago cancelado";case"refunded":return"Pago reembolsado";case"charged_back":return"Contracargo";default:return"Estado desconocido"}}static getPaymentStatusColor(e){switch(e){case"approved":return"text-green-600";case"pending":case"in_process":return"text-yellow-600";case"rejected":case"cancelled":return"text-red-600";case"refunded":case"charged_back":return"text-orange-600";default:return"text-gray-600"}}static formatCurrency(e){return new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}static convertCurrency(e){return Math.round(e)}static async createPaymentReservation(e){try{let t=await fetch("/api/mercadopago/create-reservation",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw Error("Failed to create payment reservation");return await t.json()}catch(e){throw console.error("Error creating payment reservation:",e),e}}static async capturePayment(e,t){try{let r=await fetch("/api/mercadopago/capture-payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentId:e,amount:t})});if(!r.ok)throw Error("Failed to capture payment");return await r.json()}catch(e){throw console.error("Error capturing payment:",e),e}}static async cancelPaymentAuthorization(e){try{let t=await fetch("/api/mercadopago/cancel-authorization",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentId:e})});if(!t.ok)throw Error("Failed to cancel payment authorization");return await t.json()}catch(e){throw console.error("Error canceling payment authorization:",e),e}}static async refundPayment(e,t){try{let r=await fetch("/api/mercadopago/refund-payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentId:e,amount:t})});if(!r.ok)throw Error("Failed to process refund");return await r.json()}catch(e){throw console.error("Error processing refund:",e),e}}static async createPreferenceWithHold(e){try{let t=await fetch("/api/mercadopago/create-preference-hold",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw Error("Failed to create payment preference with hold");return await t.json()}catch(e){throw console.error("Error creating payment preference with hold:",e),e}}}a.publicKey="APP_USR-b0e93ae7-6f6a-41ef-a107-384a3902e083",a.initialized=!1},17764:(e,t,r)=>{r.d(t,{ChatService:()=>i});var a=r(35317),o=r(66579);class i{static async createChatRoom(e,t,r,i){try{if(!e||0===e.length)return console.error("Cannot create chat room: no participants provided"),null;console.log("Creating chat room with participants:",e);let n={participants:e,participantDetails:t,type:r,orderId:i,createdAt:(0,a.O5)(),updatedAt:(0,a.O5)(),status:"active",unreadCount:e.reduce((e,t)=>(e[t]=0,e),{})},s=await (0,a.gS)((0,a.collection)(o.db,this.ROOMS_COLLECTION),n);return console.log("Chat room created with ID:",s.id),s.id}catch(e){return console.error("Error creating chat room:",e),e instanceof Error&&console.error("Error details:",e.message),null}}static async getOrCreateOrderChatRoom(e,t,r,i){try{console.log("Getting or creating chat room for order:",e,"participants:",{cookerId:t,customerId:r,driverId:i});let s=(0,a.query)((0,a.collection)(o.db,this.ROOMS_COLLECTION),(0,a.where)("type","==","order"),(0,a.where)("orderId","==",e)),c=await (0,a.getDocs)(s);if(!c.empty)return console.log("Chat room already exists for order:",e),c.docs[0].id;if(!t||!r)return console.error("Cannot create chat room: missing required participants (cookerId or customerId)"),null;let d=[t,r];i&&d.push(i);let l={};for(let e of d)try{let t=await (0,a.getDoc)((0,a.doc)(o.db,"users",e));if(t.exists()){var n;let r=t.data();l[e]={name:r.displayName||r.email||"Usuario",role:(null==(n=r.role)?void 0:n.toLowerCase())||"customer",avatar:r.photoURL||r.avatar}}else console.warn("User document not found for ".concat(e,", using default details")),l[e]={name:"Usuario",role:"customer"}}catch(t){console.warn("Could not load details for user ".concat(e,":"),t),l[e]={name:"Usuario",role:"customer"}}return await this.createChatRoom(d,l,"order",e)}catch(e){return console.error("Error getting or creating order chat room:",e),null}}static async sendMessage(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"text",n=arguments.length>4?arguments[4]:void 0;try{var s;let c=await (0,a.getDoc)((0,a.doc)(o.db,"users",t)),d=c.exists()?c.data():{},l={senderId:t,senderName:d.displayName||d.email||"Usuario",senderRole:(null==(s=d.role)?void 0:s.toLowerCase())||"customer",senderAvatar:d.photoURL||d.avatar,message:r,timestamp:(0,a.O5)(),type:i,metadata:n,readBy:[t]};await (0,a.gS)((0,a.collection)(o.db,this.ROOMS_COLLECTION,e,this.MESSAGES_COLLECTION),l),await (0,a.mZ)((0,a.doc)(o.db,this.ROOMS_COLLECTION,e),{lastMessage:{message:r,senderId:t,timestamp:(0,a.O5)(),type:i},updatedAt:(0,a.O5)(),["unreadCount.".concat(t)]:0});let p=await (0,a.getDoc)((0,a.doc)(o.db,this.ROOMS_COLLECTION,e));if(p.exists()){let r=p.data(),i={};r.participants.forEach(e=>{e!==t&&(i["unreadCount.".concat(e)]=(r.unreadCount[e]||0)+1)}),Object.keys(i).length>0&&await (0,a.mZ)((0,a.doc)(o.db,this.ROOMS_COLLECTION,e),i)}return console.log("Message sent successfully"),!0}catch(e){return console.error("Error sending message:",e),!1}}static async sendSystemMessage(e,t,r){try{let i={senderId:"system",senderName:"Sistema",senderRole:"admin",message:t,timestamp:(0,a.O5)(),type:"system",metadata:r,readBy:[]};return await (0,a.gS)((0,a.collection)(o.db,this.ROOMS_COLLECTION,e,this.MESSAGES_COLLECTION),i),await (0,a.mZ)((0,a.doc)(o.db,this.ROOMS_COLLECTION,e),{lastMessage:{message:t,senderId:"system",timestamp:(0,a.O5)(),type:"system"},updatedAt:(0,a.O5)()}),!0}catch(e){return console.error("Error sending system message:",e),!1}}static async markMessagesAsRead(e,t){try{return await (0,a.mZ)((0,a.doc)(o.db,this.ROOMS_COLLECTION,e),{["unreadCount.".concat(t)]:0,["participantDetails.".concat(t,".lastSeen")]:(0,a.O5)()}),!0}catch(e){return console.error("Error marking messages as read:",e),!1}}static subscribeToMessages(e,t){let r=(0,a.query)((0,a.collection)(o.db,this.ROOMS_COLLECTION,e,this.MESSAGES_COLLECTION),(0,a.orderBy)("timestamp","asc"),(0,a.limit)(100));return(0,a.aQ)(r,e=>{t(e.docs.map(e=>({id:e.id,...e.data()})))})}static subscribeToUserChatRooms(e,t){let r=(0,a.query)((0,a.collection)(o.db,this.ROOMS_COLLECTION),(0,a.where)("participants","array-contains",e),(0,a.where)("status","==","active"),(0,a.orderBy)("updatedAt","desc"));return(0,a.aQ)(r,e=>{t(e.docs.map(e=>({id:e.id,...e.data()})))})}static async getTotalUnreadCount(e){try{let t=(0,a.query)((0,a.collection)(o.db,this.ROOMS_COLLECTION),(0,a.where)("participants","array-contains",e),(0,a.where)("status","==","active")),r=await (0,a.getDocs)(t),i=0;return r.docs.forEach(t=>{let r=t.data();i+=r.unreadCount[e]||0}),i}catch(e){return console.error("Error getting total unread count:",e),0}}static async archiveChatRoom(e){try{return await (0,a.mZ)((0,a.doc)(o.db,this.ROOMS_COLLECTION,e),{status:"archived",updatedAt:(0,a.O5)()}),!0}catch(e){return console.error("Error archiving chat room:",e),!1}}static async sendLocationMessage(e,t,r){return await this.sendMessage(e,t,"\uD83D\uDCCD Ubicaci\xf3n compartida: ".concat(r.address),"location",{location:r})}static async sendOrderUpdateMessage(e,t,r,a){return await this.sendSystemMessage(e,{accepted:"✅ Pedido aceptado y en preparaci\xf3n",preparing:"\uD83D\uDC68‍\uD83C\uDF73 Preparando tu pedido...",ready:"\uD83D\uDCE6 \xa1Pedido listo para recoger!",delivering:"\uD83D\uDE9A Pedido en camino",delivered:"\uD83C\uDF89 \xa1Pedido entregado!"}[r]||"Estado actualizado: ".concat(r),{orderId:t})}}i.MESSAGES_COLLECTION="chatMessages",i.ROOMS_COLLECTION="chatRooms"},67503:(e,t,r)=>{r.d(t,{J:()=>o});var a=r(56671);class o{static initialize(){this.requestPermission(),this.setupServiceWorker(),this.loadPreferences()}static async requestPermission(){if("Notification"in window){let e=await Notification.requestPermission();this.pushEnabled="granted"===e}}static setupServiceWorker(){"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(e=>{console.log("Service Worker registered:",e)}).catch(e=>{console.error("Service Worker registration failed:",e)})}static loadPreferences(){let e=localStorage.getItem("notificationPreferences");if(e){let{soundEnabled:t}=JSON.parse(e);this.soundEnabled=t}}static create(e){let t={...e,id:this.generateId(),timestamp:new Date,read:!1};return this.notifications.unshift(t),this.notifyListeners(),this.showToast(t),this.playSound(t),this.showPushNotification(t),this.persistNotifications(),t.id}static notifyOrderReceived(e,t,r){return this.create({title:"\xa1Nuevo Pedido Recibido!",message:"".concat(t," ha realizado un pedido por $").concat(r.toLocaleString("es-CL")),type:"success",priority:"high",category:"order",action:{label:"Ver Pedido",onClick:()=>window.location.href="/cooker/dashboard?order=".concat(e)},metadata:{orderId:e,customerName:t,total:r}})}static notifyOrderStatusChange(e,t,r){return this.create({title:"Estado del Pedido Actualizado",message:{accepted:"Tu pedido ha sido aceptado y est\xe1 siendo preparado",preparing:"Tu pedido est\xe1 siendo preparado",ready:"\xa1Tu pedido est\xe1 listo para recoger!",delivering:"Tu pedido est\xe1 en camino",delivered:"\xa1Tu pedido ha sido entregado!"}[t]||"Estado: ".concat(t),type:"info",priority:"medium",category:"order",metadata:{orderId:e,status:t,role:r}})}static notifyPaymentSuccess(e,t){return this.create({title:"Pago Exitoso",message:"Tu pago de $".concat(t.toLocaleString("es-CL")," ha sido procesado correctamente"),type:"success",priority:"high",category:"payment",metadata:{orderId:e,amount:t}})}static notifyPaymentFailed(e,t){return this.create({title:"Error en el Pago",message:"No se pudo procesar tu pago: ".concat(t),type:"error",priority:"high",category:"payment",action:{label:"Reintentar",onClick:()=>window.location.href="/payment/retry?order=".concat(e)},metadata:{orderId:e,reason:t}})}static notifyDriverAssigned(e,t){return this.create({title:"Repartidor Asignado",message:"".concat(t," ha sido asignado a tu pedido"),type:"info",priority:"medium",category:"delivery",metadata:{orderId:e,driverName:t}})}static notifyDeliveryUpdate(e,t){return this.create({title:"Actualizaci\xf3n de Entrega",message:t,type:"info",priority:"medium",category:"delivery",metadata:{orderId:e}})}static notifyPromotion(e,t,r){return this.create({title:e,message:"".concat(t," - ").concat(r,"% de descuento"),type:"info",priority:"low",category:"promotion",action:{label:"Ver Oferta",onClick:()=>window.location.href="/promotions"},metadata:{discount:r}})}static markAsRead(e){let t=this.notifications.find(t=>t.id===e);t&&(t.read=!0,this.notifyListeners(),this.persistNotifications())}static markAllAsRead(){this.notifications.forEach(e=>e.read=!0),this.notifyListeners(),this.persistNotifications()}static delete(e){this.notifications=this.notifications.filter(t=>t.id!==e),this.notifyListeners(),this.persistNotifications()}static clearAll(){this.notifications=[],this.notifyListeners(),this.persistNotifications()}static getUnreadCount(){return this.notifications.filter(e=>!e.read).length}static getNotifications(e){let t=this.notifications;return(null==e?void 0:e.category)&&(t=t.filter(t=>t.category===e.category)),(null==e?void 0:e.read)!==void 0&&(t=t.filter(t=>t.read===e.read)),(null==e?void 0:e.priority)&&(t=t.filter(t=>t.priority===e.priority)),t}static subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}static notifyListeners(){this.listeners.forEach(e=>e([...this.notifications]))}static persistNotifications(){try{localStorage.setItem("notifications",JSON.stringify(this.notifications))}catch(e){console.error("Error persisting notifications:",e)}}static loadPersistedNotifications(){try{let e=localStorage.getItem("notifications");e&&(this.notifications=JSON.parse(e).map(e=>({...e,timestamp:new Date(e.timestamp)})),this.notifyListeners())}catch(e){console.error("Error loading persisted notifications:",e)}}static generateId(){return"notif_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9))}static showToast(e){let t={duration:e.duration||("high"===e.priority?5e3:3e3),action:e.action?{label:e.action.label,onClick:e.action.onClick}:void 0};switch(e.type){case"success":a.oR.success(e.title,{description:e.message,...t});break;case"error":a.oR.error(e.title,{description:e.message,...t});break;case"warning":a.oR.warning(e.title,{description:e.message,...t});break;default:a.oR.info(e.title,{description:e.message,...t})}}static playSound(e){if(this.soundEnabled&&"low"!==e.priority)try{let e=new Audio("/sounds/notification.mp3");e.volume=.3,e.play().catch(e=>{console.warn("Could not play notification sound:",e)})}catch(e){console.warn("Error playing notification sound:",e)}}static showPushNotification(e){this.pushEnabled&&"low"!==e.priority&&"Notification"in window&&"granted"===Notification.permission&&new Notification(e.title,{body:e.message,icon:"/icon-192x192.png",badge:"/icon-96x96.png",tag:e.id,requireInteraction:"high"===e.priority})}static setSoundEnabled(e){this.soundEnabled=e,localStorage.setItem("notificationPreferences",JSON.stringify({soundEnabled:e}))}static isSoundEnabled(){return this.soundEnabled}static setPushEnabled(e){this.pushEnabled=e,e&&this.requestPermission()}static isPushEnabled(){return this.pushEnabled}static cleanup(){let e=new Date;e.setDate(e.getDate()-7),this.notifications=this.notifications.filter(t=>t.timestamp>e||"high"===t.priority),this.notifyListeners(),this.persistNotifications()}static getMetrics(){let e=this.notifications.length;return{total:e,unread:this.getUnreadCount(),byCategory:this.notifications.reduce((e,t)=>(e[t.category]=(e[t.category]||0)+1,e),{})}}}o.notifications=[],o.listeners=new Set,o.soundEnabled=!0,o.pushEnabled=!1},70977:(e,t,r)=>{r.d(t,{n:()=>u});var a=r(35317),o=r(66579),i=r(46751),n=r(99895),s=r(67503),c=r(49509);class d{static async initialize(){if(!this.isInitialized)try{if(!("Notification"in window))return void console.warn("This browser does not support notifications");let e=await Notification.requestPermission();if("granted"!==e)return void console.warn("Notification permission denied");if(this.messaging=(0,n.dG)(o.y),"serviceWorker"in navigator){let e=await navigator.serviceWorker.register("/firebase-messaging-sw.js");console.log("Service Worker registered:",e)}await this.getToken(),this.setupMessageHandlers(),this.isInitialized=!0,console.log("FCM Service initialized successfully")}catch(e){console.error("Error initializing FCM:",e)}}static async getToken(){if(!this.messaging)return null;try{let e=await (0,n.gf)(this.messaging,{vapidKey:this.vapidKey});if(e)return console.log("FCM Token:",e),this.token=e,await this.saveTokenToDatabase(e),e;return console.log("No registration token available"),null}catch(e){return console.error("Error getting FCM token:",e),null}}static async saveTokenToDatabase(e){try{let t=this.getCurrentUserId();if(!t)return;if(!(await fetch("/api/fcm/save-token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:t,token:e,platform:"web",lastUpdated:new Date().toISOString()})})).ok)throw Error("Failed to save FCM token");console.log("FCM token saved to database")}catch(e){console.error("Error saving FCM token:",e)}}static setupMessageHandlers(){this.messaging&&(0,n.xD)(this.messaging,e=>{if(console.log("Foreground message received:",e),e.notification){let{title:t,body:r}=e.notification,a=e.data||{};s.J.create({title:t||"Nueva notificaci\xf3n",message:r||"",type:this.getNotificationType(a.type),priority:a.priority||"medium",category:a.category||"system",metadata:a,action:a.actionUrl?{label:"Ver detalles",onClick:()=>window.location.href=a.actionUrl}:void 0})}})}static getNotificationType(e){return({order_accepted:"success",order_ready:"success",order_delivered:"success",order_cancelled:"error",payment_success:"success",payment_failed:"error",promotion:"info",system:"info"})[e]||"info"}static async subscribeToTopic(e){if(this.token||await this.getToken(),!this.token)return void console.error("No FCM token available");try{(await fetch("/api/fcm/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:this.token,topic:e})})).ok&&console.log("Subscribed to topic: ".concat(e))}catch(e){console.error("Error subscribing to topic:",e)}}static async unsubscribeFromTopic(e){if(this.token)try{(await fetch("/api/fcm/unsubscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:this.token,topic:e})})).ok&&console.log("Unsubscribed from topic: ".concat(e))}catch(e){console.error("Error unsubscribing from topic:",e)}}static async sendNotificationToUser(e,t){try{if(!(await fetch("/api/fcm/send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e,notification:t})})).ok)throw Error("Failed to send notification");console.log("Notification sent successfully")}catch(e){console.error("Error sending notification:",e)}}static async sendOrderStatusNotification(e,t,r){let a={accepted:{title:"\xa1Pedido Aceptado! ✅",body:"Tu pedido ha sido aceptado y est\xe1 siendo preparado"},preparing:{title:"Preparando tu pedido \uD83D\uDC68‍\uD83C\uDF73",body:"Tu deliciosa comida est\xe1 siendo preparada con amor"},ready:{title:"\xa1Pedido Listo! \uD83D\uDCE6",body:"Tu pedido est\xe1 listo para ser recogido"},delivering:{title:"En camino \uD83D\uDE9A",body:"Tu pedido est\xe1 en camino. \xa1Prep\xe1rate para disfrutar!"},delivered:{title:"\xa1Entregado! \uD83C\uDF89",body:"Tu pedido ha sido entregado. \xa1Que lo disfrutes!"},cancelled:{title:"Pedido Cancelado ❌",body:"Tu pedido ha sido cancelado. Contacta soporte si necesitas ayuda"}}[r];a&&await this.sendNotificationToUser(e,{...a,data:{type:"order_".concat(r),orderId:t,actionUrl:"/orders/".concat(t),priority:"high",category:"order"}})}static async sendPromotionalNotification(e,t){try{(await fetch("/api/fcm/send-to-topic",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({topic:e,notification:{title:"\uD83C\uDF89 ".concat(t.title),body:"".concat(t.description," - Usa el c\xf3digo ").concat(t.code," para ").concat(t.discount,"% de descuento"),image:"/images/promotion-banner.jpg"},data:{type:"promotion",code:t.code,discount:t.discount.toString(),expiresAt:t.expiresAt,actionUrl:"/promotions",priority:"low",category:"promotion"}})})).ok&&console.log("Promotional notification sent")}catch(e){console.error("Error sending promotional notification:",e)}}static getCurrentUserId(){try{var e;let t=window.__AUTH_CONTEXT__;if(null==t||null==(e=t.user)?void 0:e.uid)return t.user.uid;return JSON.parse(localStorage.getItem("user")||"{}").uid||null}catch(e){return console.warn("Error getting current user ID:",e),null}}static isSupported(){return this.isInitialized&&null!==this.token}static getCurrentToken(){return this.token}static async refreshToken(){return this.token=null,await this.getToken()}}d.messaging=null,d.vapidKey=c.env.NEXT_PUBLIC_FIREBASE_VAPID_KEY||"YOUR_VAPID_KEY",d.isInitialized=!1,d.token=null;var l=r(17764),p=r(13008);class u{static async approveOrder(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:30;try{let t=await i.OrdersService.getOrderById(e);if(!t)throw Error("Order not found");let n=(0,a.doc)(o.db,"orders",e);return await (0,a.mZ)(n,{status:"accepted","cookerApproval.approved":!0,"cookerApproval.approvedAt":(0,a.O5)(),estimatedPrepTime:r,estimatedDeliveryTime:new Date(Date.now()+6e4*r),updatedAt:(0,a.O5)()}),"card"===t.paymentMethod&&t.paymentId?(await this.releasePaymentHold(t.paymentId),await (0,a.mZ)(n,{paymentStatus:"paid"})):"cash_on_delivery"===t.paymentMethod&&await (0,a.mZ)(n,{paymentStatus:"cash_pending"}),await this.sendApprovalNotifications(t,r),console.log("Order approved successfully:",e),!0}catch(e){return console.error("Error approving order:",e),!1}}static async rejectOrder(e,t,r){try{let t=await i.OrdersService.getOrderById(e);if(!t)throw Error("Order not found");let n=(0,a.doc)(o.db,"orders",e);return await (0,a.mZ)(n,{status:"rejected","cookerApproval.approved":!1,"cookerApproval.rejectedAt":(0,a.O5)(),"cookerApproval.rejectionReason":r,updatedAt:(0,a.O5)()}),"card"===t.paymentMethod&&t.paymentId&&(await this.refundPayment(t.paymentId),await (0,a.mZ)(n,{paymentStatus:"failed"})),await this.sendRejectionNotifications(t,r),console.log("Order rejected successfully:",e),!0}catch(e){return console.error("Error rejecting order:",e),!1}}static async createOrderWithApproval(e){try{let t={...e,status:"pending_approval",paymentStatus:"card"===e.paymentMethod?"pending":"cash_pending",cookerApproval:{approved:!1},createdAt:(0,a.O5)(),updatedAt:(0,a.O5)()},r=await i.OrdersService.createOrder(t);return r&&(await this.notifyCookerForApproval(r,e.cookerId,e.customerName,e.total,e.paymentMethod),await l.ChatService.getOrCreateOrderChatRoom(r,e.cookerId,e.customerId)),r}catch(e){return console.error("Error creating order with approval:",e),null}}static async releasePaymentHold(e){try{console.log("Releasing payment hold for:",e);let t=await p._.capturePayment(e);if(t.success)console.log("Payment hold released successfully:",{paymentId:t.paymentId,status:t.status,capturedAmount:t.captured_amount});else throw Error("Failed to capture payment")}catch(e){console.error("Error releasing payment hold:",e)}}static async refundPayment(e){try{console.log("Processing refund for payment:",e);try{let t=await p._.cancelPaymentAuthorization(e);if(t.success)return void console.log("Payment authorization canceled successfully:",{paymentId:t.paymentId,status:t.status})}catch(e){console.log("Could not cancel authorization, attempting refund instead:",e)}let t=await p._.refundPayment(e);if(t.success)console.log("Payment refunded successfully:",{refundId:t.refundId,paymentId:t.paymentId,amount:t.amount});else throw Error("Failed to process refund")}catch(e){console.error("Error processing refund:",e)}}static async sendApprovalNotifications(e,t){try{let r=new Date(Date.now()+6e4*t),a=r.toLocaleTimeString("es-CL",{hour:"2-digit",minute:"2-digit"});await d.sendNotificationToUser(e.customerId,{title:"✅ \xa1Orden Aprobada y Aceptada!",body:"Tu orden ha sido aprobada. Tiempo estimado: ".concat(t," min. Entrega aprox: ").concat(a),data:{orderId:e.id,type:"order_approved",actionUrl:"/orders/".concat(e.id,"/tracking"),priority:"high",estimatedDeliveryTime:r.toISOString()}});let o=await l.ChatService.getOrCreateOrderChatRoom(e.id,e.cookerId,e.customerId);o&&await l.ChatService.sendSystemMessage(o,"\uD83C\uDF89 \xa1Orden aprobada! El cocinero comenzar\xe1 la preparaci\xf3n. Tiempo estimado: ".concat(t," minutos. Entrega aproximada: ").concat(a),{orderId:e.id,type:"order_approved",estimatedPrepTime:t,estimatedDeliveryTime:r.toISOString()}),await this.sendApprovalEmail(e,t)}catch(e){console.error("Error sending approval notifications:",e)}}static async sendRejectionNotifications(e,t){try{await d.sendNotificationToUser(e.customerId,{title:"❌ Orden Rechazada",body:"Lo sentimos, tu orden fue rechazada. Raz\xf3n: ".concat(t),data:{orderId:e.id,type:"order_rejected",actionUrl:"/orders/".concat(e.id),priority:"high"}});let r=await l.ChatService.getOrCreateOrderChatRoom(e.id,e.cookerId,e.customerId);r&&await l.ChatService.sendSystemMessage(r,"❌ Orden rechazada. Raz\xf3n: ".concat(t,". ").concat("card"===e.paymentMethod?"Se procesar\xe1 el reembolso autom\xe1ticamente.":""),{orderId:e.id,type:"order_rejected",rejectionReason:t}),await this.sendRejectionEmail(e,t)}catch(e){console.error("Error sending rejection notifications:",e)}}static async notifyCookerForApproval(e,t,r,a,o){try{let i=new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP"}).format(a);await d.sendNotificationToUser(t,{title:"\uD83D\uDD14 Nueva Orden - Requiere Aprobaci\xf3n",body:"".concat(r," - ").concat(i," (").concat("card"===o?"Pago Digital":"Pago en Efectivo","). \xbfAceptas la orden?"),data:{orderId:e,type:"order_approval_required",actionUrl:"/cooker/dashboard?tab=orders&orderId=".concat(e),priority:"high",paymentMethod:o}})}catch(e){console.error("Error sending cooker approval notification:",e)}}static async sendApprovalEmail(e,t){try{console.log("Sending approval email to:",e.customerEmail||e.customerId)}catch(e){console.error("Error sending approval email:",e)}}static async sendRejectionEmail(e,t){try{console.log("Sending rejection email to:",e.customerEmail||e.customerId)}catch(e){console.error("Error sending rejection email:",e)}}}}}]);