"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7764],{17764:(e,t,a)=>{a.d(t,{ChatService:()=>s});var r=a(35317),o=a(66579);class s{static async createChatRoom(e,t,a,s){try{if(!e||0===e.length)return console.error("Cannot create chat room: no participants provided"),null;console.log("Creating chat room with participants:",e);let c={participants:e,participantDetails:t,type:a,orderId:s,createdAt:(0,r.O5)(),updatedAt:(0,r.O5)(),status:"active",unreadCount:e.reduce((e,t)=>(e[t]=0,e),{})},n=await (0,r.gS)((0,r.collection)(o.db,this.ROOMS_COLLECTION),c);return console.log("Chat room created with ID:",n.id),n.id}catch(e){return console.error("Error creating chat room:",e),e instanceof Error&&console.error("Error details:",e.message),null}}static async getOrCreateOrderChatRoom(e,t,a,s){try{console.log("Getting or creating chat room for order:",e,"participants:",{cookerId:t,customerId:a,driverId:s});let n=(0,r.query)((0,r.collection)(o.db,this.ROOMS_COLLECTION),(0,r.where)("type","==","order"),(0,r.where)("orderId","==",e)),i=await (0,r.getDocs)(n);if(!i.empty)return console.log("Chat room already exists for order:",e),i.docs[0].id;if(!t||!a)return console.error("Cannot create chat room: missing required participants (cookerId or customerId)"),null;let d=[t,a];s&&d.push(s);let l={};for(let e of d)try{let t=await (0,r.getDoc)((0,r.doc)(o.db,"users",e));if(t.exists()){var c;let a=t.data();l[e]={name:a.displayName||a.email||"Usuario",role:(null==(c=a.role)?void 0:c.toLowerCase())||"customer",avatar:a.photoURL||a.avatar}}else console.warn("User document not found for ".concat(e,", using default details")),l[e]={name:"Usuario",role:"customer"}}catch(t){console.warn("Could not load details for user ".concat(e,":"),t),l[e]={name:"Usuario",role:"customer"}}return await this.createChatRoom(d,l,"order",e)}catch(e){return console.error("Error getting or creating order chat room:",e),null}}static async sendMessage(e,t,a){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"text",c=arguments.length>4?arguments[4]:void 0;try{var n;let i=await (0,r.getDoc)((0,r.doc)(o.db,"users",t)),d=i.exists()?i.data():{},l={senderId:t,senderName:d.displayName||d.email||"Usuario",senderRole:(null==(n=d.role)?void 0:n.toLowerCase())||"customer",senderAvatar:d.photoURL||d.avatar,message:a,timestamp:(0,r.O5)(),type:s,metadata:c,readBy:[t]};await (0,r.gS)((0,r.collection)(o.db,this.ROOMS_COLLECTION,e,this.MESSAGES_COLLECTION),l),await (0,r.mZ)((0,r.doc)(o.db,this.ROOMS_COLLECTION,e),{lastMessage:{message:a,senderId:t,timestamp:(0,r.O5)(),type:s},updatedAt:(0,r.O5)(),["unreadCount.".concat(t)]:0});let u=await (0,r.getDoc)((0,r.doc)(o.db,this.ROOMS_COLLECTION,e));if(u.exists()){let a=u.data(),s={};a.participants.forEach(e=>{e!==t&&(s["unreadCount.".concat(e)]=(a.unreadCount[e]||0)+1)}),Object.keys(s).length>0&&await (0,r.mZ)((0,r.doc)(o.db,this.ROOMS_COLLECTION,e),s)}return console.log("Message sent successfully"),!0}catch(e){return console.error("Error sending message:",e),!1}}static async sendSystemMessage(e,t,a){try{let s={senderId:"system",senderName:"Sistema",senderRole:"admin",message:t,timestamp:(0,r.O5)(),type:"system",metadata:a,readBy:[]};return await (0,r.gS)((0,r.collection)(o.db,this.ROOMS_COLLECTION,e,this.MESSAGES_COLLECTION),s),await (0,r.mZ)((0,r.doc)(o.db,this.ROOMS_COLLECTION,e),{lastMessage:{message:t,senderId:"system",timestamp:(0,r.O5)(),type:"system"},updatedAt:(0,r.O5)()}),!0}catch(e){return console.error("Error sending system message:",e),!1}}static async markMessagesAsRead(e,t){try{return await (0,r.mZ)((0,r.doc)(o.db,this.ROOMS_COLLECTION,e),{["unreadCount.".concat(t)]:0,["participantDetails.".concat(t,".lastSeen")]:(0,r.O5)()}),!0}catch(e){return console.error("Error marking messages as read:",e),!1}}static subscribeToMessages(e,t){let a=(0,r.query)((0,r.collection)(o.db,this.ROOMS_COLLECTION,e,this.MESSAGES_COLLECTION),(0,r.orderBy)("timestamp","asc"),(0,r.limit)(100));return(0,r.aQ)(a,e=>{t(e.docs.map(e=>({id:e.id,...e.data()})))})}static subscribeToUserChatRooms(e,t){let a=(0,r.query)((0,r.collection)(o.db,this.ROOMS_COLLECTION),(0,r.where)("participants","array-contains",e),(0,r.where)("status","==","active"),(0,r.orderBy)("updatedAt","desc"));return(0,r.aQ)(a,e=>{t(e.docs.map(e=>({id:e.id,...e.data()})))})}static async getTotalUnreadCount(e){try{let t=(0,r.query)((0,r.collection)(o.db,this.ROOMS_COLLECTION),(0,r.where)("participants","array-contains",e),(0,r.where)("status","==","active")),a=await (0,r.getDocs)(t),s=0;return a.docs.forEach(t=>{let a=t.data();s+=a.unreadCount[e]||0}),s}catch(e){return console.error("Error getting total unread count:",e),0}}static async archiveChatRoom(e){try{return await (0,r.mZ)((0,r.doc)(o.db,this.ROOMS_COLLECTION,e),{status:"archived",updatedAt:(0,r.O5)()}),!0}catch(e){return console.error("Error archiving chat room:",e),!1}}static async sendLocationMessage(e,t,a){return await this.sendMessage(e,t,"\uD83D\uDCCD Ubicaci\xf3n compartida: ".concat(a.address),"location",{location:a})}static async sendOrderUpdateMessage(e,t,a,r){return await this.sendSystemMessage(e,{accepted:"✅ Pedido aceptado y en preparaci\xf3n",preparing:"\uD83D\uDC68‍\uD83C\uDF73 Preparando tu pedido...",ready:"\uD83D\uDCE6 \xa1Pedido listo para recoger!",delivering:"\uD83D\uDE9A Pedido en camino",delivered:"\uD83C\uDF89 \xa1Pedido entregado!"}[a]||"Estado actualizado: ".concat(a),{orderId:t})}}s.MESSAGES_COLLECTION="chatMessages",s.ROOMS_COLLECTION="chatRooms"}}]);