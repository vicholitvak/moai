(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7546],{57546:(e,n,t)=>{"use strict";t.r(n),t.d(n,{default:()=>U});var r=t(95155),a=t(12115);function l(e,n){return Object.freeze({...e,...n})}let s=(0,a.createContext)(null);function i(){let e=(0,a.use)(s);if(null==e)throw Error("No context provided: useLeafletContext() can only be used in a descendant of <MapContainer>");return e}var c=t(47650);function o(e){return(0,a.forwardRef)(function(n,t){let{instance:r,context:l}=e(n).current;(0,a.useImperativeHandle)(t,()=>r);let{children:i}=n;return null==i?null:a.createElement(s,{value:l},i)})}function u(e,n){let t=(0,a.useRef)(n);(0,a.useEffect)(function(){n!==t.current&&null!=e.attributionControl&&(null!=t.current&&e.attributionControl.removeAttribution(t.current),null!=n&&e.attributionControl.addAttribution(n)),t.current=n},[e,n])}function d(e,n){let t=(0,a.useRef)(void 0);(0,a.useEffect)(function(){return null!=n&&e.instance.on(n),t.current=n,function(){null!=t.current&&e.instance.off(t.current),t.current=null}},[e,n])}function f(e,n){let t=e.pane??n.pane;return t?{...e,pane:t}:e}function p(e,n,t){return Object.freeze({instance:e,context:n,container:t})}function m(e,n){return null==n?function(n,t){let r=(0,a.useRef)(void 0);return r.current||(r.current=e(n,t)),r}:function(t,r){let l=(0,a.useRef)(void 0);l.current||(l.current=e(t,r));let s=(0,a.useRef)(t),{instance:i}=l.current;return(0,a.useEffect)(function(){s.current!==t&&(n(i,t,s.current),s.current=t)},[i,t,n]),l}}function h(e,n){(0,a.useEffect)(function(){return(n.layerContainer??n.map).addLayer(e.instance),function(){n.layerContainer?.removeLayer(e.instance),n.map.removeLayer(e.instance)}},[n,e])}function x(e){return function(n){let t=i(),r=e(f(n,t),t);return u(t.map,n.attribution),d(r.current,n.eventHandlers),h(r.current,t),r}}var g=t(85752),j=t.n(g);let v=function(e,n){var t;return o((t=m(e,n),function(e){let n=i(),r=t(f(e,n),n);d(r.current,e.eventHandlers),h(r.current,n);var l=r.current;let s=(0,a.useRef)(void 0);return(0,a.useEffect)(function(){if(e.pathOptions!==s.current){let n=e.pathOptions??{};l.instance.setStyle(n),s.current=n}},[l,e]),r}))}(function({positions:e,...n},t){let r=new g.Polyline(e,n);return p(r,l(t,{overlayContainer:r}))},function(e,n,t){n.positions!==t.positions&&e.setLatLngs(n.positions)}),N=(0,a.forwardRef)(function({bounds:e,boundsOptions:n,center:t,children:r,className:l,id:i,placeholder:c,style:o,whenReady:u,zoom:d,...f},p){let[m]=(0,a.useState)({className:l,id:i,style:o}),[h,x]=(0,a.useState)(null),j=(0,a.useRef)(void 0);(0,a.useImperativeHandle)(p,()=>h?.map??null,[h]);let v=(0,a.useCallback)(r=>{if(null!==r&&!j.current){let a=new g.Map(r,f);j.current=a,null!=t&&null!=d?a.setView(t,d):null!=e&&a.fitBounds(e,n),null!=u&&a.whenReady(u),x(Object.freeze({__version:1,map:a}))}},[]);(0,a.useEffect)(()=>()=>{h?.map.remove()},[h]);let N=h?a.createElement(s,{value:h},r):c??null;return a.createElement("div",{...m,ref:v},N)}),b=function(e,n){var t;return t=x(m(e,n)),(0,a.forwardRef)(function(e,n){let{instance:r}=t(e).current;return(0,a.useImperativeHandle)(n,()=>r),null})}(function({url:e,...n},t){return p(new g.TileLayer(e,f(n,t)),t)},function(e,n,t){let{opacity:r,zIndex:a}=n;null!=r&&r!==t.opacity&&e.setOpacity(r),null!=a&&a!==t.zIndex&&e.setZIndex(a);let{url:l}=n;null!=l&&l!==t.url&&e.setUrl(l)}),y=o(x(m(function({position:e,...n},t){let r=new g.Marker(e,n);return p(r,l(t,{overlayContainer:r}))},function(e,n,t){n.position!==t.position&&e.setLatLng(n.position),null!=n.icon&&n.icon!==t.icon&&e.setIcon(n.icon),null!=n.zIndexOffset&&n.zIndexOffset!==t.zIndexOffset&&e.setZIndexOffset(n.zIndexOffset),null!=n.opacity&&n.opacity!==t.opacity&&e.setOpacity(n.opacity),null!=e.dragging&&n.draggable!==t.draggable&&(!0===n.draggable?e.dragging.enable():e.dragging.disable())}))),w=function(e,n){var t,r;return t=m(e),r=function(e,r){let a=i(),l=t(f(e,a),a);return u(a.map,e.attribution),d(l.current,e.eventHandlers),n(l.current,a,e,r),l},(0,a.forwardRef)(function(e,n){let[t,l]=(0,a.useState)(!1),{instance:s}=r(e,l).current;(0,a.useImperativeHandle)(n,()=>s),(0,a.useEffect)(function(){t&&s.update()},[s,t,e.children]);let i=s._contentNode;return i?(0,c.createPortal)(e.children,i):null})}(function(e,n){return p(new g.Popup(e,n.overlayContainer),n)},function(e,n,{position:t},r){(0,a.useEffect)(function(){let{instance:a}=e;function l(e){e.popup===a&&(a.update(),r(!0))}function s(e){e.popup===a&&r(!1)}return n.map.on({popupopen:l,popupclose:s}),null==n.overlayContainer?(null!=t&&a.setLatLng(t),a.openOn(n.map)):n.overlayContainer.bindPopup(a),function(){n.map.off({popupopen:l,popupclose:s}),n.overlayContainer?.unbindPopup(),n.map.removeLayer(a)}},[e,n,r,t])});t(68413);var C=t(46751),k=t(88482),O=t(88145),E=t(97168),I=t(4516),L=t(53904),R=t(29799),M=t(71007),S=t(19420),z=t(81497),A=t(14186),P=t(69663);delete j().Icon.Default.prototype._getIconUrl,j().Icon.Default.mergeOptions({iconRetinaUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png",iconUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png"});let B=(e,n)=>j().divIcon({html:'\n      <div style="\n        background-color: '.concat(e,';\n        width: 40px;\n        height: 40px;\n        border-radius: 50%;\n        border: 3px solid white;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.3);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        color: white;\n        font-size: 18px;\n      ">\n        ').concat(n,"\n      </div>\n    "),className:"custom-div-icon",iconSize:[40,40],iconAnchor:[20,20]}),T=B("#3B82F6","\uD83C\uDFE0"),_=B("#F59E0B","\uD83D\uDC68‍\uD83C\uDF73"),D=B("#10B981","\uD83D\uDE9A");function Z(e){let{locations:n}=e,t=i().map;return(0,a.useEffect)(()=>{if(n.length>0){let e=j().latLngBounds(n.map(e=>[e.lat,e.lng]));t.fitBounds(e,{padding:[20,20]})}},[n,t]),null}function H(e){let{start:n,end:t,currentPosition:l}=e,[s,i]=(0,a.useState)([]),[c,o]=(0,a.useState)(!1);(0,a.useEffect)(()=>{u()},[n,t]);let u=async()=>{if(n&&t){o(!0);try{let e=await fetch("/api/maps/directions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({origin:"".concat(n.lat,",").concat(n.lng),destination:"".concat(t.lat,",").concat(t.lng),mode:"driving"})});if(e.ok){let r=await e.json();if(r.routes&&r.routes.length>0){let e=r.routes[0].overview_polyline.points,n=d(e);i(n)}else i([[n.lat,n.lng],[t.lat,t.lng]])}else i([[n.lat,n.lng],[t.lat,t.lng]])}catch(e){console.error("Error fetching route:",e),i([[n.lat,n.lng],[t.lat,t.lng]])}finally{o(!1)}}},d=e=>{let n=[],t=0,r=e.length,a=0,l=0;for(;t<r;){let r,s=0,i=0;do i|=(31&(r=e.charCodeAt(t++)-63))<<s,s+=5;while(r>=32);a+=1&i?~(i>>1):i>>1,s=0,i=0;do i|=(31&(r=e.charCodeAt(t++)-63))<<s,s+=5;while(r>=32);l+=1&i?~(i>>1):i>>1,n.push([a/1e5,l/1e5])}return n};return 0===s.length?null:(0,r.jsx)(v,{positions:s,pathOptions:{color:"#3B82F6",weight:4,opacity:.8,dashArray:l?"10, 10":void 0}})}let U=e=>{let{orderId:n,customerLocation:t,cookLocation:l,driver:s,estimatedTime:i=30,onDriverContact:c,onTrackingUpdate:o,isAdmin:u=!1}=e,[d,f]=(0,a.useState)(!1),[p,m]=(0,a.useState)((null==s?void 0:s.currentLocation)||null),[h,x]=(0,a.useState)(!1),[g,j]=(0,a.useState)(null),v=(0,a.useRef)();(0,a.useEffect)(()=>(f(!0),s&&s.isOnline&&B(),()=>{v.current&&clearInterval(v.current)}),[s]);let B=(0,a.useCallback)(()=>C.OrdersService.subscribeToOrder(n,e=>{var n;(null==e||null==(n=e.tracking)?void 0:n.driverLocation)&&(m({lat:e.tracking.driverLocation.latitude,lng:e.tracking.driverLocation.longitude}),e.tracking.route&&j({distance:e.tracking.route.distance,duration:e.tracking.route.duration,estimatedArrival:e.tracking.route.estimatedArrival.toDate()}),o&&o(e.tracking))}),[n,o]),U=async()=>{x(!0);try{if(s){let e=await fetch("/api/drivers/".concat(s.id,"/location"));if(e.ok){let n=await e.json();m(n)}}}catch(e){console.error("Error refreshing locations:",e)}finally{x(!1)}},F=[t,l];p&&F.push(p);let W=p?((e,n)=>{let t=(n.lat-e.lat)*Math.PI/180,r=(n.lng-e.lng)*Math.PI/180,a=Math.sin(t/2)*Math.sin(t/2)+Math.cos(e.lat*Math.PI/180)*Math.cos(n.lat*Math.PI/180)*Math.sin(r/2)*Math.sin(r/2);return 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))*6371})(p,t).toFixed(1):null;return d?(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)(k.Zp,{children:[(0,r.jsx)(k.aR,{className:"pb-3",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)(k.ZB,{className:"flex items-center gap-2",children:[(0,r.jsx)(I.A,{className:"h-5 w-5"}),"Seguimiento en Tiempo Real"]}),(0,r.jsx)(E.$,{variant:"ghost",size:"sm",onClick:U,disabled:h,children:(0,r.jsx)(L.A,{className:"h-4 w-4 ".concat(h?"animate-spin":"")})})]})}),(0,r.jsx)(k.Wu,{className:"p-0",children:(0,r.jsx)("div",{className:"h-96 w-full rounded-b-lg overflow-hidden",children:(0,r.jsxs)(N,{center:[t.lat,t.lng],zoom:13,style:{height:"100%",width:"100%"},zoomControl:!0,children:[(0,r.jsx)(b,{attribution:'\xa9 <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),(0,r.jsx)(Z,{locations:F}),(0,r.jsx)(y,{position:[t.lat,t.lng],icon:T,children:(0,r.jsx)(w,{children:(0,r.jsxs)("div",{className:"p-2",children:[(0,r.jsx)("h3",{className:"font-semibold",children:"Tu ubicaci\xf3n"}),(0,r.jsx)("p",{className:"text-sm text-muted-foreground",children:t.address||"Direcci\xf3n de entrega"})]})})}),(0,r.jsx)(y,{position:[l.lat,l.lng],icon:_,children:(0,r.jsx)(w,{children:(0,r.jsxs)("div",{className:"p-2",children:[(0,r.jsx)("h3",{className:"font-semibold",children:"Cocina"}),(0,r.jsx)("p",{className:"text-sm text-muted-foreground",children:l.address||"Ubicaci\xf3n del cocinero"})]})})}),p&&(0,r.jsx)(y,{position:[p.lat,p.lng],icon:D,children:(0,r.jsx)(w,{children:(0,r.jsxs)("div",{className:"p-2",children:[(0,r.jsx)("h3",{className:"font-semibold",children:"Repartidor"}),(0,r.jsxs)("p",{className:"text-sm text-muted-foreground",children:[null==s?void 0:s.name," - ",null==s?void 0:s.vehicleType]}),W&&(0,r.jsxs)("p",{className:"text-sm",children:["A ",W," km de tu ubicaci\xf3n"]})]})})}),p&&(0,r.jsx)(H,{start:p,end:t,currentPosition:p})]})})})]}),s&&(0,r.jsxs)(k.Zp,{children:[(0,r.jsx)(k.aR,{className:"pb-3",children:(0,r.jsxs)(k.ZB,{className:"flex items-center gap-2",children:[(0,r.jsx)(R.A,{className:"h-5 w-5"}),"Tu Repartidor"]})}),(0,r.jsx)(k.Wu,{children:(0,r.jsxs)("div",{className:"flex items-start gap-4",children:[(0,r.jsxs)(P.eu,{className:"h-16 w-16",children:[(0,r.jsx)(P.BK,{src:s.avatar}),(0,r.jsx)(P.q5,{children:(0,r.jsx)(M.A,{className:"h-6 w-6"})})]}),(0,r.jsxs)("div",{className:"flex-1 space-y-2",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("h3",{className:"font-semibold",children:s.name}),(0,r.jsx)(O.E,{variant:s.isOnline?"default":"secondary",children:s.isOnline?"En l\xednea":"Desconectado"})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-muted-foreground",children:"Veh\xedculo"}),(0,r.jsx)("p",{className:"font-medium",children:s.vehicleType})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-muted-foreground",children:"Placa"}),(0,r.jsx)("p",{className:"font-medium",children:s.licensePlate})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-muted-foreground",children:"Calificaci\xf3n"}),(0,r.jsxs)("p",{className:"font-medium",children:["⭐ ",s.rating]})]}),W&&(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-muted-foreground",children:"Distancia"}),(0,r.jsxs)("p",{className:"font-medium",children:[W," km"]})]})]}),(0,r.jsxs)("div",{className:"flex gap-2 pt-2",children:[(0,r.jsxs)(E.$,{variant:"outline",size:"sm",className:"flex-1",onClick:c,children:[(0,r.jsx)(S.A,{className:"h-4 w-4 mr-2"}),"Llamar"]}),(0,r.jsxs)(E.$,{variant:"outline",size:"sm",className:"flex-1",children:[(0,r.jsx)(z.A,{className:"h-4 w-4 mr-2"}),"Chat"]})]})]})]})})]}),(0,r.jsx)(k.Zp,{children:(0,r.jsx)(k.Wu,{className:"p-4",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)(A.A,{className:"h-5 w-5 text-primary"}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"font-medium",children:"Tiempo estimado de llegada"}),(0,r.jsx)("p",{className:"text-sm text-muted-foreground",children:"Basado en el tr\xe1fico actual"})]})]}),(0,r.jsxs)("div",{className:"text-right",children:[(0,r.jsxs)("p",{className:"text-2xl font-bold",children:[i," min"]}),(0,r.jsx)("p",{className:"text-sm text-muted-foreground",children:new Date(Date.now()+6e4*i).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]})})})]}):(0,r.jsx)(k.Zp,{children:(0,r.jsxs)(k.Wu,{className:"p-8 text-center",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"}),(0,r.jsx)("p",{className:"text-muted-foreground",children:"Cargando mapa..."})]})})}},68413:()=>{}}]);