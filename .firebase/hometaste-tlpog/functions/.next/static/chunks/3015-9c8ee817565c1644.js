"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3015],{23015:(e,t,r)=>{r.d(t,{VK:()=>l});var a=r(35317),s=r(66579);r(12115);class i{generateKey(e){return"".concat(this.prefix).concat(e)}isExpired(e){return Date.now()>e.expiry}evictOldest(){if(this.cache.size<this.maxSize)return;let e="",t=Date.now();for(let[r,a]of this.cache.entries())a.timestamp<t&&(t=a.timestamp,e=r);e&&this.cache.delete(e)}set(e,t,r){let a=this.generateKey(e),s=Date.now()+(r||this.defaultTTL);this.evictOldest(),this.cache.set(a,{data:t,timestamp:Date.now(),expiry:s})}get(e){let t=this.generateKey(e),r=this.cache.get(t);return!r||this.isExpired(r)?(r&&this.cache.delete(t),null):r.data}has(e){let t=this.generateKey(e),r=this.cache.get(t);return!(!r||this.isExpired(r))||(r&&this.cache.delete(t),!1)}delete(e){let t=this.generateKey(e);return this.cache.delete(t)}clear(){this.cache.clear()}cleanup(){for(let[e,t]of this.cache.entries())this.isExpired(t)&&this.cache.delete(e)}getStats(){let e=this.cache.size;return{size:e,maxSize:this.maxSize,hitRate:0,memoryUsage:"".concat(Math.round(.1*e),"KB")}}cached(e,t,r){return new Promise(async(a,s)=>{try{let s=this.get(e);if(null!==s)return void a(s);let i=await t();this.set(e,i,r),a(i)}catch(e){s(e)}})}invalidatePattern(e){let t=new RegExp(e);for(let e of this.cache.keys())t.test(e)&&this.cache.delete(e)}getKeys(){return Array.from(this.cache.keys())}constructor(e){this.cache=new Map,this.defaultTTL=3e5,this.maxSize=1e3,this.prefix="moai_cache_",(null==e?void 0:e.ttl)&&(this.defaultTTL=e.ttl),(null==e?void 0:e.maxSize)&&(this.maxSize=e.maxSize),(null==e?void 0:e.prefix)&&(this.prefix=e.prefix),setInterval(()=>this.cleanup(),3e5)}}let c=new i({ttl:6e5,maxSize:500,prefix:"dish_"}),h=new i({ttl:9e5,maxSize:200,prefix:"cook_"});new i({ttl:12e4,maxSize:300,prefix:"order_"}),new i({ttl:18e5,maxSize:100,prefix:"user_"});let o=new i({ttl:3e5,maxSize:200,prefix:"search_"});new i({ttl:36e5,maxSize:100,prefix:"location_"}),new i;class n{async getFirstPage(){try{let e=(0,a.query)(this.baseQuery,(0,a.limit)(this.pageSize)),t=await (0,a.getDocs)(e),r=t.docs.map(e=>({id:e.id,...e.data()}));return t.docs.length>0&&(this.cursors=[t.docs[t.docs.length-1]]),this.currentPage=1,{data:r,hasNextPage:t.docs.length===this.pageSize,hasPreviousPage:!1,currentPage:this.currentPage,nextCursor:t.docs[t.docs.length-1],loading:!1}}catch(e){return{data:[],hasNextPage:!1,hasPreviousPage:!1,currentPage:0,loading:!1,error:e}}}async getNextPage(){if(0===this.cursors.length)return this.getFirstPage();try{let e=this.cursors[this.cursors.length-1],t=(0,a.query)(this.baseQuery,(0,a.HM)(e),(0,a.limit)(this.pageSize)),r=await (0,a.getDocs)(t),s=r.docs.map(e=>({id:e.id,...e.data()}));return r.docs.length>0&&this.cursors.push(r.docs[r.docs.length-1]),this.currentPage++,{data:s,hasNextPage:r.docs.length===this.pageSize,hasPreviousPage:this.currentPage>1,currentPage:this.currentPage,nextCursor:r.docs[r.docs.length-1],previousCursor:this.cursors[this.cursors.length-2],loading:!1}}catch(e){return{data:[],hasNextPage:!1,hasPreviousPage:this.currentPage>1,currentPage:this.currentPage,loading:!1,error:e}}}async getPreviousPage(){if(this.cursors.length<2||this.currentPage<=1)return this.getFirstPage();try{this.cursors.pop();let e=this.cursors[this.cursors.length-1],t=(0,a.query)(this.baseQuery,(0,a.rf)(e),(0,a.limit)(this.pageSize)),r=await (0,a.getDocs)(t),s=r.docs.map(e=>({id:e.id,...e.data()}));return this.currentPage--,{data:s,hasNextPage:!0,hasPreviousPage:this.currentPage>1,currentPage:this.currentPage,nextCursor:r.docs[r.docs.length-1],previousCursor:this.cursors[this.cursors.length-2],loading:!1}}catch(e){return{data:[],hasNextPage:!1,hasPreviousPage:this.currentPage>1,currentPage:this.currentPage,loading:!1,error:e}}}reset(){this.cursors=[],this.currentPage=0}getCurrentPageInfo(){return{currentPage:this.currentPage,pageSize:this.pageSize,hasNextPage:this.cursors.length>0,hasPreviousPage:this.currentPage>1}}constructor(e,t={}){this.cursors=[],this.currentPage=0,this.baseQuery=e,this.pageSize=t.pageSize||20,this.orderByField=t.orderByField||"createdAt",this.orderDirection=t.orderDirection||"desc";let r=[];t.filters&&t.filters.forEach(e=>{r.push((0,a.where)(e.field,e.operator,e.value))}),r.push((0,a.orderBy)(this.orderByField,this.orderDirection)),this.baseQuery=(0,a.query)(this.baseQuery,...r)}}class l{static async getDishes(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{cookId:t,category:a,pageSize:i=this.DEFAULT_PAGE_SIZE,useCache:h=!0}=e,o="dishes_".concat(t||"all","_").concat(a||"all","_").concat(i);if(h){let e=c.get(o);if(e)return{data:e.data,hasMore:e.hasMore}}try{let{getDocs:e,limit:t,collection:a,query:n}=await Promise.resolve().then(r.bind(r,35317)),l=n(a(s.db,"dishes"),t(i)),d=await e(l),u=d.docs.map(e=>({id:e.id,...e.data()}));return h&&c.set(o,{data:u,hasMore:d.docs.length===i},this.CACHE_TTL),{data:u,hasMore:d.docs.length===i}}catch(e){return console.error("Error fetching dishes:",e),{data:[],hasMore:!1}}}static async getDishById(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1],r="dish_".concat(e);if(t){let e=c.get(r);if(e)return e}try{let i=await (0,a.getDoc)((0,a.doc)(s.db,"dishes",e));if(!i.exists())return null;let h={id:i.id,...i.data()};return t&&c.set(r,h,this.CACHE_TTL),h}catch(e){return console.error("Error fetching dish:",e),null}}static async getPopularDishes(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,t=!(arguments.length>1)||void 0===arguments[1]||arguments[1],r="popular_dishes_".concat(e);if(t){let e=c.get(r);if(e)return e}try{let i=(0,a.query)((0,a.collection)(s.db,"dishes"),(0,a.where)("isAvailable","==",!0),(0,a.orderBy)("rating","desc"),(0,a.orderBy)("reviewCount","desc"),(0,a.limit)(e)),h=(await (0,a.getDocs)(i)).docs.map(e=>({id:e.id,...e.data()}));return t&&c.set(r,h,this.CACHE_TTL),h}catch(e){return console.error("Error fetching popular dishes:",e),[]}}static async searchDishes(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{category:r,maxPrice:a,minRating:s=0,pageSize:i=this.DEFAULT_PAGE_SIZE,useCache:c=!0}=t,h="search_".concat(e,"_").concat(r||"all","_").concat(a||"any","_").concat(s,"_").concat(i);if(c){let r=o.get(h);if(r){let a=new n(this.buildSearchQuery(e,t),{pageSize:i});return{data:r.data,hasMore:r.hasMore,pagination:a}}}try{let r=this.buildSearchQuery(e,t),a=new n(r,{pageSize:i,orderByField:"rating",orderDirection:"desc"}),s=await a.getFirstPage();return c&&!s.error&&o.set(h,{data:s.data,hasMore:s.hasNextPage},3e5),{data:s.data,hasMore:s.hasNextPage,pagination:a}}catch(r){return console.error("Error searching dishes:",r),{data:[],hasMore:!1,pagination:new n(this.buildSearchQuery(e,t),{pageSize:i})}}}static buildDishesQuery(e){let t=(0,a.collection)(s.db,"dishes"),r=[];return e.cookId&&r.push((0,a.where)("cookerId","==",e.cookId)),e.category&&r.push((0,a.where)("category","==",e.category)),void 0!==e.isAvailable&&r.push((0,a.where)("isAvailable","==",e.isAvailable)),r.length>0?(0,a.query)(t,...r):(0,a.query)(t)}static buildSearchQuery(e,t){let r=(0,a.collection)(s.db,"dishes"),i=[(0,a.where)("isAvailable","==",!0)];if(t.category&&i.push((0,a.where)("category","==",t.category)),t.maxPrice&&i.push((0,a.where)("price","<=",t.maxPrice)),t.minRating&&t.minRating>0&&i.push((0,a.where)("rating",">=",t.minRating)),e){let t=e.toLowerCase();i.push((0,a.where)("tags","array-contains",t))}return(0,a.query)(r,...i)}static invalidateCache(e,t){e&&c.delete("dish_".concat(e)),t&&c.invalidatePattern(".*cook_".concat(t,".*")),c.invalidatePattern("dishes_.*"),c.invalidatePattern("popular_dishes_.*"),o.clear()}}l.CACHE_TTL=6e5,l.DEFAULT_PAGE_SIZE=20;class d{static async getCooks(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{isActive:t=!0,minRating:r=0,pageSize:a=20,useCache:s=!0}=e,i="cooks_".concat(t,"_").concat(r,"_").concat(a);if(s){let t=h.get(i);if(t){let r=new n(this.buildCooksQuery(e),{pageSize:a});return{data:t.data,hasMore:t.hasMore,pagination:r}}}try{let t=this.buildCooksQuery(e),r=new n(t,{pageSize:a,orderByField:"rating",orderDirection:"desc"}),c=await r.getFirstPage();return s&&!c.error&&h.set(i,{data:c.data,hasMore:c.hasNextPage},this.CACHE_TTL),{data:c.data,hasMore:c.hasNextPage,pagination:r}}catch(t){return console.error("Error fetching cooks:",t),{data:[],hasMore:!1,pagination:new n(this.buildCooksQuery(e),{pageSize:a})}}}static async getCookById(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1],r="cook_".concat(e);if(t){let e=h.get(r);if(e)return e}try{let i=await (0,a.getDoc)((0,a.doc)(s.db,"cooks",e));if(!i.exists())return null;let c={id:i.id,...i.data()};return t&&h.set(r,c,this.CACHE_TTL),c}catch(e){return console.error("Error fetching cook:",e),null}}static buildCooksQuery(e){let t=(0,a.collection)(s.db,"cooks"),r=[];return void 0!==e.isActive&&r.push((0,a.where)("isActive","==",e.isActive)),e.minRating&&e.minRating>0&&r.push((0,a.where)("rating",">=",e.minRating)),r.length>0?(0,a.query)(t,...r):(0,a.query)(t)}static invalidateCache(e){e&&h.delete("cook_".concat(e)),h.invalidatePattern("cooks_.*")}}d.CACHE_TTL=9e5}}]);