"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3226],{25539:(e,i,r)=>{r.d(i,{T:()=>t});class t{static async initialize(){try{if(!("serviceWorker"in navigator))return console.warn("Service Workers not supported"),{permission:"denied",supported:!1,serviceWorkerRegistered:!1};if(!("Notification"in window))return console.warn("Notifications not supported"),{permission:"denied",supported:!1,serviceWorkerRegistered:!1};try{return this.serviceWorkerRegistration=await navigator.serviceWorker.register("/sw.js",{scope:"/"}),console.log("Service Worker registered successfully:",this.serviceWorkerRegistration),await navigator.serviceWorker.ready,this.isInitialized=!0,navigator.serviceWorker.addEventListener("message",this.handleServiceWorkerMessage),{permission:Notification.permission,supported:!0,serviceWorkerRegistered:!0}}catch(e){return console.error("Service Worker registration failed:",e),{permission:Notification.permission,supported:!0,serviceWorkerRegistered:!1}}}catch(e){return console.error("Error initializing push notifications:",e),{permission:"denied",supported:!1,serviceWorkerRegistered:!1}}}static async requestPermission(){try{if(!("Notification"in window))return console.warn("Notifications not supported"),"denied";if("granted"===Notification.permission)return"granted";if("denied"===Notification.permission)return console.warn("Notification permission denied by user"),"denied";let e=await Notification.requestPermission();return console.log("Notification permission:",e),e}catch(e){return console.error("Error requesting notification permission:",e),"denied"}}static async showLocalNotification(e){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{if(!("Notification"in window))return void console.warn("Notifications not supported");if("granted"!==Notification.permission)return void console.warn("Notification permission not granted");let r={icon:"/icon-192x192.png",badge:"/icon-96x96.png",vibrate:[200,100,200],requireInteraction:!1,...i},t=new Notification(e,r);r.requireInteraction||setTimeout(()=>{t.close()},8e3),t.onclick=e=>{e.preventDefault(),t.close(),i.data&&i.data.url?(window.focus(),window.location.href=i.data.url):window.focus()}}catch(e){console.error("Error showing local notification:",e)}}static async showServiceWorkerNotification(e){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{if(!this.serviceWorkerRegistration)return console.warn("Service Worker not registered, falling back to local notification"),this.showLocalNotification(e,i);await this.serviceWorkerRegistration.showNotification(e,{icon:"/icon-192x192.png",badge:"/icon-96x96.png",vibrate:[200,100,200],requireInteraction:!1,...i})}catch(r){return console.error("Error showing service worker notification:",r),this.showLocalNotification(e,i)}}static async showOrderNotification(e){try{if("granted"!==Notification.permission)return void console.warn("Notification permission not granted");let i="Moai - Actualizaci\xf3n de Pedido",r="Tu pedido ha sido actualizado",t="/icon-192x192.png",o=!1,n=[200,100,200],a=[];switch(e.orderStatus){case"accepted":i="✅ Pedido Confirmado",r="Tu pedido #".concat(e.orderId.slice(-8)," ha sido confirmado").concat(e.cookerName?" por ".concat(e.cookerName):""),t="/notifications/accepted.png",a=[{action:"view",title:"Ver Pedido"}];break;case"preparing":i="\uD83D\uDC68‍\uD83C\uDF73 Preparando tu Pedido",r="".concat(e.cookerName||"El cocinero"," est\xe1 preparando tu pedido. \xa1Ya casi est\xe1 listo!"),t="/notifications/preparing.png",a=[{action:"track",title:"Ver Progreso"}];break;case"ready":i="\uD83C\uDF7D️ \xa1Pedido Listo!",r="Tu comida est\xe1 lista. Buscando conductor para la entrega.",t="/notifications/ready.png",n=[300,100,300,100,300],o=!0;break;case"delivering":i="\uD83D\uDE97 Conductor Asignado",r="".concat(e.driverName||"Un conductor"," est\xe1 en camino con tu pedido").concat(e.eta?". ETA: ".concat(e.eta):""),t="/notifications/delivering.png",a=[{action:"track",title:"Seguir en Tiempo Real"}],n=[200,100,200],o=!0;break;case"delivered":i="\uD83C\uDF89 \xa1Pedido Entregado!",r="\xa1Disfruta tu comida! No olvides calificar tu experiencia.",t="/notifications/delivered.png",a=[{action:"rate",title:"Calificar"}],n=[300,100,300,100,300,100,300],o=!0;break;case"cancelled":i="❌ Pedido Cancelado",r="Tu pedido ha sido cancelado. Te reembolsaremos el dinero.",t="/notifications/cancelled.png",a=[{action:"support",title:"Contactar Soporte"}];break;default:r=e.message||"Tu pedido ha sido actualizado"}let s={body:r,icon:t,badge:"/icon-96x96.png",vibrate:n,requireInteraction:o,actions:a,data:{orderId:e.orderId,orderStatus:e.orderStatus,url:e.url||"/orders/".concat(e.orderId,"/tracking"),timestamp:Date.now()},tag:"order-".concat(e.orderId),renotify:!0};this.serviceWorkerRegistration?await this.showServiceWorkerNotification(i,s):await this.showLocalNotification(i,s)}catch(e){console.error("Error showing order notification:",e)}}static getPermissionStatus(){return{permission:"Notification"in window?Notification.permission:"denied",supported:"Notification"in window&&"serviceWorker"in navigator,serviceWorkerRegistered:!!this.serviceWorkerRegistration}}static async showTestNotification(){await this.showOrderNotification({orderId:"test-order-123",orderStatus:"delivering",driverName:"Juan P\xe9rez",eta:"15 min",message:"Esta es una notificaci\xf3n de prueba"})}static cleanup(){"serviceWorker"in navigator&&navigator.serviceWorker.removeEventListener("message",this.handleServiceWorkerMessage)}static async setNotificationsEnabled(e){try{localStorage.setItem("moai-notifications-enabled",e.toString()),e&&"granted"!==Notification.permission&&await this.requestPermission(),console.log("Notifications",e?"enabled":"disabled")}catch(e){console.error("Error setting notification preference:",e)}}static areNotificationsEnabled(){let e=localStorage.getItem("moai-notifications-enabled");return null===e||"true"===e}}t.serviceWorkerRegistration=null,t.isInitialized=!1,t.handleServiceWorkerMessage=e=>{console.log("Received message from service worker:",e.data),e.data&&"NOTIFICATION_CLICKED"===e.data.type&&console.log("Notification was clicked:",e.data)}},63226:(e,i,r)=>{r.d(i,{a:()=>s,u:()=>c});var t=r(12115),o=r(25731),n=r(46751),a=r(25539);function s(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{user:i}=(0,o.A)(),{enabled:s=!0,enabledStatuses:c=["accepted","preparing","ready","delivering","delivered","cancelled"]}=e,d=(0,t.useRef)(new Map),l=(0,t.useRef)(null),u=(0,t.useRef)(!0);(0,t.useEffect)(()=>{s&&i&&a.T.initialize()},[s,i]);let g=(0,t.useCallback)(async e=>{try{if(!s||!a.T.areNotificationsEnabled()||!c.includes(e.newStatus)||u.current||e.oldStatus===e.newStatus)return;console.log("Order status changed:",e);let i="",t="",o="";if(e.order.cookerId)try{let t=await Promise.resolve().then(r.bind(r,46751)).then(i=>{let{CooksService:r}=i;return r.getCookById(e.order.cookerId)});i=(null==t?void 0:t.displayName)||""}catch(e){console.error("Error getting cooker name:",e)}if("delivering"===e.newStatus&&e.order.driverId)try{let[i,n]=await Promise.all([Promise.resolve().then(r.bind(r,46751)).then(i=>{let{DriversService:r}=i;return r.getDriverById(e.order.driverId)}),r.e(4597).then(r.bind(r,44597)).then(i=>{let{DeliveryTrackingService:r}=i;return new Promise(i=>{let t=r.subscribeToDeliveryTracking(e.orderId,e=>{t(),i(e)})})})]);t=(null==i?void 0:i.displayName)||"",o=(null==n?void 0:n.estimatedDeliveryTime)||""}catch(e){console.error("Error getting driver data:",e)}await a.T.showOrderNotification({orderId:e.orderId,orderStatus:e.newStatus,cookerName:i,driverName:t,eta:o,url:"/orders/".concat(e.orderId,"/tracking")})}catch(e){console.error("Error handling order status change:",e)}},[s,c]);return(0,t.useEffect)(()=>{if(i&&s)return l.current&&l.current(),l.current=n.OrdersService.subscribeToOrderUpdates(i.uid,e=>{let i=new Map;e.forEach(e=>{let r=d.current.get(e.id);i.set(e.id,e.status),r&&r!==e.status&&g({orderId:e.id,oldStatus:r,newStatus:e.status,order:e})}),d.current=i,u.current&&(u.current=!1)}),()=>{l.current&&(l.current(),l.current=null)}},[i,s,g]),(0,t.useEffect)(()=>()=>{l.current&&l.current()},[]),{showTestNotification:()=>a.T.showTestNotification(),requestPermission:()=>a.T.requestPermission(),getPermissionStatus:()=>a.T.getPermissionStatus(),showOrderNotification:(e,i,r)=>a.T.showOrderNotification({orderId:e,orderStatus:i,...r})}}function c(e){let i=!(arguments.length>1)||void 0===arguments[1]||arguments[1],o=(0,t.useRef)(!1);return(0,t.useEffect)(()=>{if(!i||!e)return;let t=null;return r.e(4597).then(r.bind(r,44597)).then(i=>{let{DeliveryTrackingService:r}=i;t=r.subscribeToDeliveryTracking(e,async i=>{if(i&&"heading_to_delivery"===i.currentStep&&i.estimatedDeliveryTime&&!o.current){let r=i.estimatedDeliveryTime.toLowerCase();(r.includes("1 min")||r.includes("2 min")||r.includes("llegando")||r.includes("cerca"))&&(o.current=!0,await a.T.showOrderNotification({orderId:e,orderStatus:"arriving",driverName:i.driverName,eta:i.estimatedDeliveryTime,message:"".concat(i.driverName," est\xe1 llegando a tu ubicaci\xf3n. \xa1Prep\xe1rate para recibir tu pedido!")}))}})}),()=>{t&&t()}},[e,i]),{resetArrivedNotification:()=>{o.current=!1}}}}}]);