"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2104],{89852:(e,t,i)=>{i.d(t,{p:()=>r});var o=i(95155);i(12115);var a=i(53999);function r(e){let{className:t,type:i,...r}=e;return(0,o.jsx)("input",{type:i,"data-slot":"input",className:(0,a.cn)("file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm","focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]","aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",t),...r})}},98199:(e,t,i)=>{i.d(t,{N:()=>n});var o=i(35317),a=i(66579),r=i(49509);class n{static async getCurrentPosition(){return new Promise((e,t)=>{if(!navigator.geolocation)return void t(Error("Geolocation is not supported by this browser"));navigator.geolocation.getCurrentPosition(t=>{e({latitude:t.coords.latitude,longitude:t.coords.longitude,accuracy:t.coords.accuracy,timestamp:o.Dc.now()})},e=>{t(Error("Geolocation error: ".concat(e.message)))},{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4})})}static async getAddressFromCoordinates(e,t){let o=r.env.NEXT_PUBLIC_OPENCAGE_API_KEY;if(!o||"YOUR_OPENCAGE_API_KEY"===o){let{ChileanCitiesService:o}=await i.e(6927).then(i.bind(i,16927)),a=o.getNearbyCities(e,t,10);if(a.length>0){let e=a[0];return{street:"Direcci\xf3n no disponible",city:e.name,state:e.region,zipCode:"",country:"Chile",fullAddress:"".concat(e.name,", ").concat(e.region,", Chile")}}return{street:"Direcci\xf3n no disponible",city:"Santiago",state:"Regi\xf3n Metropolitana",zipCode:"",country:"Chile",fullAddress:"Santiago, Regi\xf3n Metropolitana, Chile"}}try{let a=await fetch("https://api.opencagedata.com/geocode/v1/json?q=".concat(e,"+").concat(t,"&key=").concat(o,"&language=es&countrycode=cl"));if(!a.ok)throw console.warn("Geocoding service temporarily unavailable, using fallback address"),Error("Geocoding service unavailable");let r=await a.json();if(r.results&&r.results.length>0){let e=r.results[0],t=e.components;return{street:"".concat(t.house_number||""," ").concat(t.road||"").trim(),city:t.city||t.town||t.village||"Santiago",state:t.state||"Regi\xf3n Metropolitana",zipCode:t.postcode||"",country:t.country||"Chile",fullAddress:e.formatted}}{let{ChileanCitiesService:o}=await i.e(6927).then(i.bind(i,16927)),a=o.getNearbyCities(e,t,10);if(a.length>0){let e=a[0];return{street:"Direcci\xf3n no disponible",city:e.name,state:e.region,zipCode:"",country:"Chile",fullAddress:"".concat(e.name,", ").concat(e.region,", Chile")}}return{street:"Direcci\xf3n no disponible",city:"Santiago",state:"Regi\xf3n Metropolitana",zipCode:"",country:"Chile",fullAddress:"Santiago, Regi\xf3n Metropolitana, Chile"}}}catch(r){let{ChileanCitiesService:o}=await i.e(6927).then(i.bind(i,16927)),a=o.getNearbyCities(e,t,10);if(a.length>0){let e=a[0];return{street:"Direcci\xf3n no disponible",city:e.name,state:e.region,zipCode:"",country:"Chile",fullAddress:"".concat(e.name,", ").concat(e.region,", Chile")}}return r instanceof Error&&!r.message.includes("Geocoding service unavailable")&&console.error("Unexpected error getting address:",r),{street:"Direcci\xf3n no disponible",city:"Santiago",state:"Regi\xf3n Metropolitana",zipCode:"",country:"Chile",fullAddress:"Santiago, Regi\xf3n Metropolitana, Chile"}}}static calculateDistance(e,t,i,o){let a=this.toRadians(i-e),r=this.toRadians(o-t),n=Math.sin(a/2)*Math.sin(a/2)+Math.cos(this.toRadians(e))*Math.cos(this.toRadians(i))*Math.sin(r/2)*Math.sin(r/2);return Math.round(2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n))*63710)/10}static toRadians(e){return Math.PI/180*e}static async updateCookLocation(e){try{let t=await this.getCurrentPosition(),i=await this.getAddressFromCoordinates(t.latitude,t.longitude),r={coordinates:t,address:i,isActive:!0,lastUpdated:o.Dc.now()};return await (0,o.mZ)((0,o.doc)(a.db,"cooks",e),{location:r,"settings.lastLocationUpdate":o.Dc.now()}),!0}catch(e){return console.error("Error updating cook location:",e),!1}}static startDriverTracking(e,t){return this.isTracking?(console.warn("Location tracking is already active"),!1):navigator.geolocation?(this.isTracking=!0,this.watchId=navigator.geolocation.watchPosition(async i=>{try{let r={latitude:i.coords.latitude,longitude:i.coords.longitude,accuracy:i.coords.accuracy,timestamp:o.Dc.now()},n=await this.getAddressFromCoordinates(r.latitude,r.longitude),s={driverId:e,coordinates:r,address:n,isActive:!0,isOnline:!0,lastUpdated:o.Dc.now()};null!==i.coords.heading&&void 0!==i.coords.heading&&(s.heading=i.coords.heading),null!==i.coords.speed&&void 0!==i.coords.speed&&(s.speed=3.6*i.coords.speed),await (0,o.mZ)((0,o.doc)(a.db,"drivers",e),{currentLocation:s,lastLocationUpdate:o.Dc.now(),isOnline:!0}),t&&t(s)}catch(e){console.error("Error updating driver location:",e)}},t=>{console.error("Geolocation error:",t),this.stopDriverTracking(e)},{enableHighAccuracy:!0,timeout:15e3,maximumAge:5e3}),!0):(console.error("Geolocation is not supported"),!1)}static async stopDriverTracking(e){null!==this.watchId&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.isTracking=!1;try{await (0,o.mZ)((0,o.doc)(a.db,"drivers",e),{isOnline:!1,lastLocationUpdate:o.Dc.now()})}catch(e){console.error("Error updating driver offline status:",e)}}static subscribeToDriverLocation(e,t){return(0,o.aQ)((0,o.doc)(a.db,"drivers",e),e=>{e.exists()?t(e.data().currentLocation):t(null)})}static async getNearbyCooks(e,t){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;try{return(await i.e(6751).then(i.bind(i,46751)).then(e=>e.CooksService.getAllCooks())).filter(i=>{var a;return!!(null==(a=i.location)?void 0:a.coordinates)&&this.calculateDistance(e,t,i.location.coordinates.latitude,i.location.coordinates.longitude)<=o}).map(i=>({...i,distance:this.calculateDistance(e,t,i.location.coordinates.latitude,i.location.coordinates.longitude)})).sort((e,t)=>e.distance-t.distance)}catch(e){return console.error("Error getting nearby cooks:",e),[]}}static estimateDeliveryTime(e){return Math.ceil(15+e/25*60)}static async checkLocationPermission(){if(!navigator.permissions)return!1;try{let e=await navigator.permissions.query({name:"geolocation"});return"granted"===e.state}catch(e){return console.error("Error checking location permission:",e),!1}}static async requestLocationPermission(){try{return await this.getCurrentPosition(),!0}catch(e){return console.error("Location permission denied:",e),!1}}static getDefaultDeliveryZones(){return[{id:"zone-centro",name:"Centro de Santiago",coordinates:[],center:{latitude:-33.4489,longitude:-70.6693,timestamp:o.Dc.now()},radius:5e3,deliveryFee:2e3,isActive:!0,maxDeliveryTime:45,priority:1,description:"Centro hist\xf3rico y comercial de Santiago",operatingHours:{start:"08:00",end:"22:00"}},{id:"zone-providencia",name:"Providencia",coordinates:[],center:{latitude:-33.4242,longitude:-70.6118,timestamp:o.Dc.now()},radius:3e3,deliveryFee:2500,isActive:!0,maxDeliveryTime:35,priority:2,description:"Zona residencial y comercial",operatingHours:{start:"09:00",end:"23:00"}},{id:"zone-las-condes",name:"Las Condes",coordinates:[],center:{latitude:-33.4172,longitude:-70.5476,timestamp:o.Dc.now()},radius:4e3,deliveryFee:3e3,isActive:!0,maxDeliveryTime:50,priority:3,description:"Distrito financiero y residencial",operatingHours:{start:"10:00",end:"22:00"}},{id:"zone-nunoa",name:"\xd1u\xf1oa",coordinates:[],center:{latitude:-33.4569,longitude:-70.5956,timestamp:o.Dc.now()},radius:3500,deliveryFee:2300,isActive:!0,maxDeliveryTime:40,priority:4,description:"Comuna universitaria y residencial",operatingHours:{start:"08:30",end:"22:30"}}]}static isWithinDeliveryZone(e,t){return 1e3*this.calculateDistance(e.latitude,e.longitude,t.center.latitude,t.center.longitude)<=t.radius}static findDeliveryZone(e,t){let i=t.filter(t=>t.isActive&&this.isWithinDeliveryZone(e,t)).sort((e,t)=>e.priority-t.priority);return i.length>0?i[0]:null}static isPointInPolygon(e,t){let i=!1;for(let o=0,a=t.length-1;o<t.length;a=o++)t[o].latitude>e.latitude!=t[a].latitude>e.latitude&&e.longitude<(t[a].longitude-t[o].longitude)*(e.latitude-t[o].latitude)/(t[a].latitude-t[o].latitude)+t[o].longitude&&(i=!i);return i}static calculateDeliveryTime(e){return 15+Math.ceil(5*e)}static calculateDeliveryFee(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.getDefaultDeliveryZones(),o=this.calculateDistance(e.latitude,e.longitude,t.latitude,t.longitude),a=this.findDeliveryZone(e,i),r=0;o>3&&(r=800*Math.ceil(o-3));let n=a?a.deliveryFee:2500,s=1500+r+n,c=this.estimateAdvancedDeliveryTime(o,a);return{baseFee:1500,distanceFee:r,zoneFee:n,totalFee:s,distance:Math.round(10*o)/10,estimatedTime:c}}static estimateAdvancedDeliveryTime(e,t){let i=20;t&&(i=Math.min(i,t.maxDeliveryTime-15));let o=new Date().getHours(),a=1;return o>=7&&o<=9||o>=18&&o<=20?a=1.5:o>=12&&o<=14&&(a=1.2),Math.max(15,Math.ceil(i+e/22*60*a))}static isDeliveryAllowed(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.getDefaultDeliveryZones();return t.some(t=>t.isActive&&this.isWithinDeliveryZone(e,t))}static getDeliveryRestrictions(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.getDefaultDeliveryZones(),i=this.findDeliveryZone(e,t);return i?{allowed:!0,zone:i}:{allowed:!1,reason:"Esta direcci\xf3n est\xe1 fuera de nuestras zonas de entrega",nearestZone:t.filter(e=>e.isActive).map(t=>({zone:t,distance:this.calculateDistance(e.latitude,e.longitude,t.center.latitude,t.center.longitude)})).sort((e,t)=>e.distance-t.distance)[0]}}static async getDishesForLocation(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;try{if(!this.getDeliveryRestrictions(e).allowed)return[];let o=await this.getNearbyCooks(e.latitude,e.longitude,t),{DishesService:a}=await i.e(6751).then(i.bind(i,46751));return(await a.getAllDishes()).filter(e=>o.find(t=>t.id===e.cookerId)&&e.isAvailable).map(t=>{let i=o.find(e=>e.id===t.cookerId),a=this.calculateDeliveryFee(e,i.location.coordinates);return{...t,cookDistance:i.distance,deliveryFee:a.totalFee,estimatedDeliveryTime:a.estimatedTime,cookLocation:i.location}}).sort((e,t)=>e.cookDistance-t.cookDistance)}catch(e){return console.error("Error getting dishes for location:",e),[]}}static async getDishesForChileanCity(e){try{let{ChileanCitiesService:t}=await i.e(6927).then(i.bind(i,16927)),o=t.getCityById(e);if(!o)return console.warn("City ".concat(e," not found")),[];if(!t.isCityOperating(e))return[];let a=await this.getNearbyCooks(o.coordinates.latitude,o.coordinates.longitude,o.maxDeliveryRadius),{DishesService:r}=await i.e(6751).then(i.bind(i,46751));return(await r.getAllDishes()).filter(e=>a.find(t=>t.id===e.cookerId)&&e.isAvailable).map(i=>{let r=a.find(e=>e.id===i.cookerId),n=t.getDeliveryFeeForCity(e);return{...i,cityId:e,cityName:o.name,region:o.region,cookDistance:r.distance,deliveryFee:n,estimatedDeliveryTime:this.calculateDeliveryTime(r.distance),cookLocation:r.location,localSpecialties:t.getLocalSpecialtiesForCity(e),popularDishes:t.getPopularDishesForCity(e)}}).sort((e,t)=>e.cookDistance-t.cookDistance)}catch(e){return console.error("Error getting dishes for Chilean city:",e),[]}}static async getDishesForCurrentLocation(){try{let e=await this.getCurrentPosition();await this.getAddressFromCoordinates(e.latitude,e.longitude);let{ChileanCitiesService:t}=await i.e(6927).then(i.bind(i,16927)),o=t.getNearbyCities(e.latitude,e.longitude,50);if(!(o.length>0))return await this.getDishesForLocation(e,15);{let e=o[0];return await this.getDishesForChileanCity(e.id)}}catch(e){return console.error("Error getting dishes for current location:",e),[]}}static async getAvailableChileanCities(){try{let{ChileanCitiesService:e}=await i.e(6927).then(i.bind(i,16927));return e.getActiveCities().map(t=>({id:t.id,name:t.name,region:t.region,coordinates:t.coordinates,deliveryFee:t.deliveryFee,isOperating:e.isCityOperating(t.id),operatingHours:e.getOperatingHoursForCity(t.id),popularDishes:t.popularDishes,localSpecialties:t.localSpecialties}))}catch(e){return console.error("Error getting available Chilean cities:",e),[]}}static formatDeliveryFee(e){return"$".concat(e.toLocaleString("es-CL")," CLP")}static formatDistance(e){return e<1?"".concat(Math.round(1e3*e)," m"):"".concat(e.toFixed(1)," km")}static getDeliveryZoneById(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.getDefaultDeliveryZones();return t.find(t=>t.id===e)||null}static isZoneOperating(e){if(!e.operatingHours)return!0;let t=new Date,i="".concat(t.getHours().toString().padStart(2,"0"),":").concat(t.getMinutes().toString().padStart(2,"0"));return i>=e.operatingHours.start&&i<=e.operatingHours.end}static getActiveZones(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.getDefaultDeliveryZones();return e.filter(e=>e.isActive&&this.isZoneOperating(e))}}n.watchId=null,n.isTracking=!1}}]);